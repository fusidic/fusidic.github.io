<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Microservices in Golang - Part1 - Fusidic&#039;s blog</title><meta description="原作者：Ewan Valentine 原文链接：https:&amp;#x2F;&amp;#x2F;ewanvalentine.io&amp;#x2F;microservices-in-golang-part-1&amp;#x2F; 引言《Go微服务》系列文章包括十个部分，这是系列的第一篇。本系列中将会用到protobuf与gRPC作为服务间的通讯协议。我花了很长时间找到了这个简洁明了的解决方案，所以我想将我所了解的有关微服务项目创建、测试以及微服务端到端部署的知识分"><meta property="og:type" content="blog"><meta property="og:title" content="Microservices in Golang - Part1"><meta property="og:url" content="https://fusidic.github.io/"><meta property="og:site_name" content="Fusidic&#039;s blog"><meta property="og:description" content="原作者：Ewan Valentine 原文链接：https:&amp;#x2F;&amp;#x2F;ewanvalentine.io&amp;#x2F;microservices-in-golang-part-1&amp;#x2F; 引言《Go微服务》系列文章包括十个部分，这是系列的第一篇。本系列中将会用到protobuf与gRPC作为服务间的通讯协议。我花了很长时间找到了这个简洁明了的解决方案，所以我想将我所了解的有关微服务项目创建、测试以及微服务端到端部署的知识分"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-04-07T15:52:06.000Z"><meta property="article:modified_time" content="2020-04-08T06:31:32.659Z"><meta property="article:author" content="arithbar"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Microservices"><meta property="article:tag" content="Translation"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://fusidic.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://fusidic.github.io/2020/04/07/MicroservicesinGolangPart1/"},"headline":"Fusidic's blog","image":["https://fusidic.github.io/img/og_image.png"],"datePublished":"2020-04-07T15:52:06.000Z","dateModified":"2020-04-08T06:31:32.659Z","author":{"@type":"Person","name":"arithbar"},"description":"原作者：Ewan Valentine 原文链接：https:&#x2F;&#x2F;ewanvalentine.io&#x2F;microservices-in-golang-part-1&#x2F; 引言《Go微服务》系列文章包括十个部分，这是系列的第一篇。本系列中将会用到protobuf与gRPC作为服务间的通讯协议。我花了很长时间找到了这个简洁明了的解决方案，所以我想将我所了解的有关微服务项目创建、测试以及微服务端到端部署的知识分"}</script><link rel="canonical" href="https://fusidic.github.io/2020/04/07/MicroservicesinGolangPart1/"><link rel="icon" href="/img/favicon.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/fusidic"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-04-07T15:52:06.000Z" title="2020-04-07T15:52:06.000Z">2020-04-07</time><span class="level-item"><a class="link-muted" href="/categories/Developments/">Developments</a><span> / </span><a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></span><span class="level-item">32 分钟 读完 (大约 4828 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Microservices in Golang - Part1</h1><div class="content"><p>原作者：Ewan Valentine</p>
<p>原文链接：<a href="https://ewanvalentine.io/microservices-in-golang-part-1/">https://ewanvalentine.io/microservices-in-golang-part-1/</a></p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>《Go微服务》系列文章包括十个部分，这是系列的第一篇。本系列中将会用到<code>protobuf</code>与<code>gRPC</code>作为服务间的通讯协议。我花了很长时间找到了这个简洁明了的解决方案，所以我想将我所了解的有关微服务项目创建、测试以及微服务端到端部署的知识分享给刚接触这个领域的新手们。</p>
<p>在教程中，我们将介绍一些基本概念，术语，并以最原始的形式创建我们的第一个微服务。</p>
<p>在整个系列中，我们将会创建以下服务：</p>
<ul>
<li>consighments</li>
<li>users</li>
<li>authentication</li>
<li>vessels</li>
</ul>
<p>我们需要用到的技术栈包括：golang, mongodb, grpc, docker, Google Cloud, Kubernetes(容器编排), NATS(消息中间件), CircleCI, Terraform(实例操作工具，代替kubectl), go-micro.</p>
<a id="more"></a>

<p>源码仓库：</p>
<ol>
<li><a href="https://github.com/EwanValentine/shippy-service-consignment">Consignment Service</a></li>
<li><a href="https://github.com/EwanValentine/shippy-ci-consignment">Consignment CLI</a></li>
</ol>
<h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><ul>
<li>了解Golang及其生态</li>
<li>安装 gRPC / protobuf - <a href="https://grpc.io/docs/quickstart/go.html">see here</a></li>
<li>安装 Golang - <a href="https://golang.org/doc/install">see here</a></li>
<li>安装如下go仓库：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go get -u google.golang.org/grpc</span><br><span class="line">$ go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>



<h2 id="我们要做什么？"><a href="#我们要做什么？" class="headerlink" title="我们要做什么？"></a>我们要做什么？</h2><p>我们也许会构建一个你能想到最简单的微服务实例，一个<strong>码头集装箱管理平台</strong>！对于微服务来说，构建一个博客未免有点杀鸡用牛刀，所以我想用一个项目既能展现微服务的<strong>低耦合</strong>，又具有一定的复杂度。这听起来像是一个有趣的挑战！</p>
<p>接下来就是正文内容了。</p>
  <br/>

<h2 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h2><p>在传统整体应用 (Monolith Application) 中，所有的功能结构都被写入到了一个单体应用中。有时它们会被按照类型来进行分组，比如<code>controllers</code>, <code>entities</code>, <code>factories</code>等，其他时候，大型应用可能按照关注点或者按照功能来进行划分，所以我们可能会有一个<code>auth</code>包，一个<code>friends</code>包，以及一个<code>articles</code>包。它们各自都有自己的<code>factories</code>, <code>services</code>, <code>repositories</code>, <code>models</code>等，但最终它们都将会被组织到同一个代码库中。</p>
<p>微服务的理念就是在第二种方法上继续延伸：我们依然按照关注点或者功能拆分，并且这些包各自都是一个可以独立运行的代码库。</p>
  <br/>

<h2 id="为什么用微服务？"><a href="#为什么用微服务？" class="headerlink" title="为什么用微服务？"></a>为什么用微服务？</h2><p><strong>复杂度</strong> - 将功能划分成微服务使你可以将整个项目划分成更小的代码块，正如早期unix开发哲学——“做好一件事”。整体应用的发展趋势使功能结合得愈加紧密，且使得关注的边界变得模糊。随着复杂度的提升，出现漏洞的风险越来越高，集成的难度也越来越大。</p>
<p><strong>拓展性</strong> - 在单体应用中，某些代码的使用频率可能远高于其他部分，当需要扩展的时候，我们只能将整个代码库全部进行水平扩展，所以假设当你的认证服务访问频率非常高的时候，你需要将整个代码库都复制到新的服务器上来应对认证访问的需求。</p>
<p>微服务的理念，这种松耦合的理念允许你分别扩展单个服务，这意味着更高效的水平扩展。这点在多核、多区域云计算中能够发挥相当好的效果。</p>
<p><strong>Nginx在微服务方面有很多非常好的文章，<a href="https://www.nginx.com/blog/introduction-to-microservices/">please give this a read</a>.</strong></p>
  <br/>

<h2 id="为什么用Golang？"><a href="#为什么用Golang？" class="headerlink" title="为什么用Golang？"></a>为什么用Golang？</h2><p>尽管微服务支持几乎所有的语言，但毕竟微服务只是一种<strong>概念</strong>而非具体的框架或者工具。一些语言对微服务有着更好的支持，而Golang就是其中之一。</p>
<p>Golang是一个轻量化、快捷的语言，同时它对并发提供了很好的支持，非常适合运行在多台多核机器上，能够充分发挥它们的性能。</p>
<p>Go语言同时包含了强大的标准库，对web服务有着良好的支持。</p>
<p>最后，Go语言有个强力的微服务框架 - go-micro，用它！</p>
  <br/>

<h2 id="protobuf-gRPC-简述"><a href="#protobuf-gRPC-简述" class="headerlink" title="protobuf gRPC 简述"></a>protobuf gRPC 简述</h2><p>由于微服务被拆分为不同的代码库，一个很重要的问题——如何在这些微服务之间进行通信。在单体应用中通讯并不是一个问题，因为你可以在代码库中直接调用其他代码。然而微服务并不能这样做，所以需要这些相互独立的应用需要一个相互通信的方法，延迟越低越好。</p>
<p>当然可以使用传统的REST方式，诸如基于http的JSON、XML。但是这个方法存在一个问题：服务A将数据编码成JSON/XML，并将字符串发送给服务B，B再将其解码需要付出一定的代价，这在一定规模的系统中有潜在的开销问题。尽管我们在同浏览器交互时必须采用这种方法，但是服务之间的通信用有更好的方法。</p>
<p>那就是 <a href="https://grpc.io/">gRPC</a>，gRPC是Google发行的一个基于二进制的轻量通讯协议。它本身包含很多东西，让我们来对它进行一些剖析。gRPC使用二进制作为其核心编码方式，以使用JSON的RESTful为例，我们通过http协议以字符串的形式发送数据，字符串中包含大量元数据，用来描述其编码格式、长度、内容的格式以及其他重要信息。这就是一台服务器向一个传统浏览器客户端发送其所需数据的方式。对于两个服务之间的通信来说，我们并不需要这么多东西，所以我们可以直接用二进制，这更轻量。gRPC使用新的HTTP 2.0规范，该规范允许使用二进制数据，它甚至允许双向流式传输，这非常酷！HTTP 2是gRPC运作的基础，关于HTTP 2.0，更多内容请看Google的 <a href="https://developers.google.com/web/fundamentals/performance/http2/">这篇文章</a>.</p>
  <br/>

<p>但我们该怎么利用二进制数据呢？gRPC有一个内置的数据交换协议名为protobuf，Protobuf允许我们使用对开发者更有好的格式定义一个微服务的接口。</p>
<p>那就让我们来定义我们第一个服务吧，在你仓库的根目录中创建<code>consignment-service/proto/consignment/consignment.proto</code>，在初期我会将我们所有的服务都放在一个仓库里面，是不是感觉还是整体仓库的结构？这是为了让教学更简单。关于是否使用单体仓库有很多争论，我们这里不去涉及，你当然也可以把服务和组件放在不同的仓库中。</p>
<p><em>这里有一篇<a href="https://blog.gopheracademy.com/advent-2017/go-grpc-beyond-basics/">关于gRPC的文章</a>我非常推荐。</em></p>
<p>在刚才创建的<code>consignment.proto</code>中，加入一下内容：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shippy-service-consignment/proto/consignment/consignment.proto</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> consignment; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">ShippingService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateConsignment(Consignment) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message Consignment &#123;</span></span><br><span class="line"><span class="function">  string id = 1</span>;</span><br><span class="line">  <span class="built_in">string</span> description = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> weight = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> Container containers = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">string</span> vessel_id = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> customer_id = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">string</span> origin = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">string</span> user_id = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> created = <span class="number">1</span>;</span><br><span class="line">  Consignment consignment = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>尽管这只是一个非常基础的例子，仍然有一些值得注意的地方。首先，你要定义你的<code>service</code>，其中包含你希望暴露给其他服务的接口，其次你需要定义<code>message</code>的类型，这其实就是你的数据结构。Protobuf是静态类型，你可以自定义类型，就像我们在<code>Container</code>中定义的那样，<code>message</code>就是我们定义的类型。</p>
<p>这里需要用的的库有两个，<code>messages</code>由protobuf处理，我们定义的<code>service</code>则由gRPC protobuf插件处理，该插件编译我们的定义，生成相应的代码，同诸如<code>service</code>这些类型进行交互。</p>
<p>protobuf的定义之后还需要通过命令行工具(CLI)生成支持二进制数据和函数的接口代码。在<code>consignment-service/</code>路径下运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> protoc -I. --go_out=plugins=grpc:. \</span></span><br><span class="line">	   proto/consignment/consignment.proto</span><br></pre></td></tr></table></figure>

<p>这段命令会调用protoc库，负责将protobuf定义编译成代码。我们还指定使用grpc插件，同时构建了上下文和生成路径。</p>
<blockquote>
<p>译者注：如果正使用go module，请先安装protobuf：<code>$ sudo apt install protobuf-compiler</code></p>
<p>protoc库<code>$ go get -u github.com/golang/protobuf/protoc-gen-go</code></p>
</blockquote>
<p>运行这行命令，你可以在<code>proto/consignment/</code>路径下发现新生成的代码，这个代码由gRPC/protobuf库自动生成，允许我们的代码使用protobuf定义生成的接口(interface)。</p>
  <br/>

<blockquote>
<p>译者注：</p>
<p>可以参照<a href="https://github.com/EwanValentine/shippy/blob/tutorial-1/consignment-service/Makefile">Makefile</a>文件，在路径下使用<code>make build</code>，同样的效果</p>
<p>在生成的<code>consignment.pb.go</code>中，可以看到<code>Consignment</code> <code>Container</code> <code>Response</code> 的实体，均对各个属性自动生成了相应的get方法。此外还有<code>service</code>对应的实体<code>ShippingServiceServer</code> : </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ShippingServiceServer is the server API for ShippingService service.</span></span><br><span class="line"><span class="keyword">type</span> ShippingServiceServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	CreateConsignment(context.Context, *Consignment) (*Response, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnimplementedShippingServiceServer can be embedded to have forward compatible implementations.</span></span><br><span class="line"><span class="keyword">type</span> UnimplementedShippingServiceServer <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*UnimplementedShippingServiceServer)</span> <span class="title">CreateConsignment</span><span class="params">(ctx context.Context, req *Consignment)</span> <span class="params">(*Response, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="string">"method CreateConsignment not implemented"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterShippingServiceServer</span><span class="params">(s *grpc.Server, srv ShippingServiceServer)</span></span> &#123;</span><br><span class="line">	s.RegisterService(&amp;_ShippingService_serviceDesc, srv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中定义了<code>ShippingServiceServer</code>的接口以及需要实现的方法<code>CreateConsignment(context.Context, *Consignment)</code>，这个方法需要用户自行实现</p>
</blockquote>
  <br/>

<p>完成这些设置之后，创建<code>consignment-service/main.go</code> 来实现这个接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-service/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 导入生成的consignment.pb.go，注意修改导入地址</span></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUserName&gt;/shippy-service-consignment/proto/consignment"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc/reflection"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	port = <span class="string">":50051"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	Create(*pb.Consignment) (*pb.Consignment, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Repository - 模拟仓库, 用来模拟数据库，之后会用一个真的实现</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu           sync.RWMutex</span><br><span class="line">	consignments []*pb.Consignment</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new consignment</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *Repository)</span> <span class="title">Create</span><span class="params">(consignment *pb.Consignment)</span> <span class="params">(*pb.Consignment, error)</span></span> &#123;</span><br><span class="line">	repo.mu.Lock()</span><br><span class="line">	updated := <span class="built_in">append</span>(repo.consignments, consignment)</span><br><span class="line">	repo.consignments = updated</span><br><span class="line">	repo.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span> consignment, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service 需要实现protobuf.service中的所有定义，可以直接在pb.go中查找需要实现</span></span><br><span class="line"><span class="comment">// 的方法以及函数签名。</span></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">	repo repository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateConsignment - 在service中我们只创建了一个方法，即Create方法，需要</span></span><br><span class="line"><span class="comment">// context和request作为参数，pb.Consignment由gRPC服务器处理并返回</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">CreateConsignment</span><span class="params">(ctx context.Context, req *pb.Consignment)</span> <span class="params">(*pb.Response, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save our consignment</span></span><br><span class="line">	consignment, err := s.repo.Create(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return matching the `Response` message we created in our</span></span><br><span class="line">	<span class="comment">// protobuf definition.</span></span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Response&#123;Created: <span class="literal">true</span>, Consignment: consignment&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	repo := &amp;Repository&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set-up our gRPC server.</span></span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register 在gRPC服务器上注册微服务，将我们的实现代码和自动生成的接口</span></span><br><span class="line">  <span class="comment">// 连接起来</span></span><br><span class="line">	pb.RegisterShippingServiceServer(s, &amp;service&#123;repo&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register reflection service on gRPC server.</span></span><br><span class="line">	reflection.Register(s)</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">"Running on port:"</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to serve: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请仔细阅读代码中的注释。以上内容主要实现了protobuf中定义接口的方法，并在50051端口创建了一个gRPC服务器。接下来我们就有一个功能完整的gRPC服务了，你可以使用<code>go run main.go</code>运行，但是你现在既没法看见什么，也没法使用这个gRPC服务器…好吧，接下来我们来创建一个客户端来查看它的运行情况。</p>
<blockquote>
<p>译者注：</p>
<p><code>repository</code>中我们定义了接口，在结构体Repository中我们实现了<code>Create()</code>方法，之后结构体<code>service</code>中调用了接口中的方法，而直到<code>main()</code>中的这一步，我们才讲方法实现和接口进行绑定。(知道需要用的时候才bind)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">  </span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register our service with the gRPC server, this will tie our</span></span><br><span class="line">	<span class="comment">// implementation into the auto-generated interface code for our</span></span><br><span class="line">	<span class="comment">// protobuf definition.</span></span><br><span class="line">	<span class="comment">// 这里通过&amp;service&#123;repo&#125; 将实现了方法的&amp;Repository&#123;&#125;传入了service</span></span><br><span class="line">	<span class="comment">// 将方法与对象进行了绑定</span></span><br><span class="line">	pb.RegisterShippingServiceServer(s, &amp;service&#123;repo&#125;)</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
  <br/>

<p>接下来使用<code>go mod</code>来初始化你的项目：</p>
<p><em>注：go mod需要go version 1.11及以上</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go mod init github.com/&lt;YourUserName&gt;/shippy-service-consignment</span><br><span class="line">$ go get -u</span><br></pre></td></tr></table></figure>

<blockquote>
<p>译者注：</p>
<p>为了使用自己的<code>consignment.pb.go</code>，你需要将仓库上传到github中</p>
<p>替代方法：<code>go.mod</code>加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace github.com&#x2F;fusidic&#x2F;go-microsvc&#x2F;consignment&#x2F;proto&#x2F;consignment &#x3D;&gt; &#x2F;root&#x2F;workspace&#x2F;go&#x2F;go-microsvc&#x2F;consignment-service&#x2F;proto&#x2F;consignment&#x2F;consignment.pb.go</span><br></pre></td></tr></table></figure>
</blockquote>
  <br/>

<p>接下来创建一个CLI (Command Line Interface), 它会从JSON文件中读取consignment(货运)信息，并与gRPC服务器交互。</p>
<p>接下来在根目录创建文件夹<code>mkdir consignment-cli</code>，并在其中创建一个<code>cli.go</code>:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-cli/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line"></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUserName&gt;/shippy-service-consignment/proto/consignment"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	address         = <span class="string">"localhost:50051"</span></span><br><span class="line">	defaultFilename = <span class="string">"consignment.json"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseFile</span><span class="params">(file <span class="keyword">string</span>)</span> <span class="params">(*pb.Consignment, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> consignment *pb.Consignment</span><br><span class="line">	data, err := ioutil.ReadFile(file)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	json.Unmarshal(data, &amp;consignment)</span><br><span class="line">	<span class="keyword">return</span> consignment, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set up a connection to the server.</span></span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Did not connect: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	client := pb.NewShippingServiceClient(conn)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">	file := defaultFilename</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">		file = os.Args[<span class="number">1</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	consignment, err := parseFile(file)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Could not parse file: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r, err := client.CreateConsignment(context.Background(), consignment)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Could not greet: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">"Created: %t"</span>, r.Created)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>创建一个货运JSON文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"This is a test consignment"</span>,</span><br><span class="line">  <span class="attr">"weight"</span>: <span class="number">550</span>,</span><br><span class="line">  <span class="attr">"containers"</span>: [</span><br><span class="line">    &#123; <span class="attr">"customer_id"</span>: <span class="string">"cust001"</span>, <span class="attr">"user_id"</span>: <span class="string">"user001"</span>, <span class="attr">"origin"</span>: <span class="string">"Manchester, United Kingdom"</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"vessel_id"</span>: <span class="string">"vessel001"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>现在如果你在<code>consignment-service</code>中使用<code>$ go run main.go</code>，并创建一个新的终端，在<code>consignment-cli</code>中运行另外一个<code>$ go run cli.go</code>，此时你可以看见一条消息：<code>Created: true</code>。</p>
<p>我们该如何确认真的完成创建了呢？让我们更新一下我们的微服务，加入一个<code>GetConsignments</code>方法，如此一来我们就可以看见我们创建的consignments了。</p>
  <br/>

<p>首先我们需要更新我们的proto定义（已在注释中标明）</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shippy-service-consignment/proto/consignment/consignment.proto</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> consignment;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">ShippingService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateConsignment(Consignment) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // Created a new method</span></span><br><span class="line"><span class="function">  <span class="keyword">rpc</span> GetConsignments(GetRequest) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message Consignment &#123;</span></span><br><span class="line"><span class="function">  string id = 1</span>;</span><br><span class="line">  <span class="built_in">string</span> description = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> weight = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> Container containers = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">string</span> vessel_id = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> customer_id = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">string</span> origin = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">string</span> user_id = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Created a blank get request</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">GetRequest</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> created = <span class="number">1</span>;</span><br><span class="line">  Consignment consignment = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Added a pluralised consignment to our generic response message</span></span><br><span class="line">  <span class="keyword">repeated</span> Consignment consignments = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>接下来就需要创建<code>GetConsignments</code>方法了，我们同样也需要新建一个<code>GetRequest</code>，目前暂时还不包括任何内容。同时我们也需要在response消息中加入<code>consignments</code>字段，你可能会注意到此处类型前的关键词<code>repeated</code>，这是为了将该类型作为数组来处理。</p>
<p>之后需要用之前提到的命令重新构建proto定义，我可能会看到类似这样的错误：<code>*service does not implement consignment.ShippingServiceServer (missing GetConsignments method)</code>.</p>
<p>这是由于我们gRPC中的方法是基于定义的接口构建的，而此处我们需要实现新的接口。</p>
<p>更新<code>consignment-service/main.go</code>文件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUsername&gt;/shippy-service-consignment/proto/consignment"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	port = <span class="string">":50051"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	Create(*pb.Consignment) (*pb.Consignment, error)</span><br><span class="line">	GetAll() []*pb.Consignment</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Repository - Dummy repository, this simulates the use of a datastore</span></span><br><span class="line"><span class="comment">// of some kind. We'll replace this with a real implementation later on.</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu           sync.RWMutex</span><br><span class="line">	consignments []*pb.Consignment</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new consignment</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *Repository)</span> <span class="title">Create</span><span class="params">(consignment *pb.Consignment)</span> <span class="params">(*pb.Consignment, error)</span></span> &#123;</span><br><span class="line">	repo.mu.Lock()</span><br><span class="line">	updated := <span class="built_in">append</span>(repo.consignments, consignment)</span><br><span class="line">	repo.consignments = updated</span><br><span class="line">	repo.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span> consignment, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAll consignments</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *Repository)</span> <span class="title">GetAll</span><span class="params">()</span> []*<span class="title">pb</span>.<span class="title">Consignment</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> repo.consignments</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service should implement all of the methods to satisfy the service</span></span><br><span class="line"><span class="comment">// we defined in our protobuf definition. You can check the interface</span></span><br><span class="line"><span class="comment">// in the generated code itself for the exact method signatures etc</span></span><br><span class="line"><span class="comment">// to give you a better idea.</span></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">	repo repository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateConsignment - we created just one method on our service,</span></span><br><span class="line"><span class="comment">// which is a create method, which takes a context and a request as an</span></span><br><span class="line"><span class="comment">// argument, these are handled by the gRPC server.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">CreateConsignment</span><span class="params">(ctx context.Context, req *pb.Consignment)</span> <span class="params">(*pb.Response, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save our consignment</span></span><br><span class="line">	consignment, err := s.repo.Create(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Return matching the `Response` message we created in our</span></span><br><span class="line">	<span class="comment">// protobuf definition.</span></span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Response&#123;Created: <span class="literal">true</span>, Consignment: consignment&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetConsignments 这就是我们现在需要增加的方法实现了</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span> <span class="title">GetConsignments</span><span class="params">(ctx context.Context, req *pb.GetRequest)</span> <span class="params">(*pb.Response, error)</span></span> &#123;</span><br><span class="line">	consignments := s.repo.GetAll()</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Response&#123;Consignments: consignments&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	repo := &amp;Repository&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set-up our gRPC server.</span></span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register our service with the gRPC server, this will tie our</span></span><br><span class="line">	<span class="comment">// implementation into the auto-generated interface code for our</span></span><br><span class="line">	<span class="comment">// protobuf definition.</span></span><br><span class="line">  <span class="comment">// 这里通过&amp;service&#123;repo&#125; 将实现了方法的&amp;Repository&#123;&#125;传入了service</span></span><br><span class="line">	<span class="comment">// 将方法与对象进行了绑定</span></span><br><span class="line">	pb.RegisterShippingServiceServer(s, &amp;service&#123;repo&#125;)</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">"Running on port:"</span>, port)</span><br><span class="line">	<span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to serve: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>以上，我们已经实现了<code>GetConsignments</code>方法，更新git仓库、实现proto定义的接口之后，如果再运行<code>$ go run main.go</code>，应该可以正常工作了。</p>
<p>接下来更新我们的cli工具<code>consignment-cli/cli.go</code>，在<code>main()</code>末尾添加:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ... </span><br><span class="line"></span><br><span class="line">	getAll, err := client.GetConsignments(context.Background(), &amp;pb.GetRequest&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Could not list consignments: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> getAll.Consignments &#123;</span><br><span class="line">		log.Println(v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <br/>

<p>在主函数的最下面，我们增加“Created: success“消息的输出，重新运行<code>$ go run cli.go</code>，创建consignment之后，再调用<code>GetConsignments</code>你就可以看见创建的consignments的列表。</p>
<p><em>注：为简洁起见，有时我可能会编辑以前用…编写过的代码，以表示未对之前的代码进行任何更改，但添加或添加了其他行。</em></p>
  <br/>

<p>好了，到这你应该已经成功的创建了一个微服务并创建了一个客户端通过gRPC与之交互了。</p>
<p>下一章节我们将介绍集成框架 <a href="https://github.com/micro/go-micro">go-micro</a>，这是一个基于gRPC创建的微服务框架，而且我们将会创建我们的第二个服务，并使用Docker来容器化我们的服务。</p>
<p>关于这篇文章，如果你发现了错误或者有反馈，please <a href="mailto:ewan.valentine89@gmail.com">drop me an email</a>.</p>
<p>教程的仓库：</p>
<ol>
<li><a href="https://github.com/EwanValentine/shippy-service-consignment">Consignment Service</a></li>
<li><a href="https://github.com/EwanValentine/shippy-service-consignment">Consignment CLI</a></li>
</ol>
<p>觉得这系列文章对您有帮助，可以请原作者喝杯咖啡，Cheers! <a href="https://monzo.me/ewanvalentine">https://monzo.me/ewanvalentine</a>.</p>
<p>或者通过 <a href="https://www.patreon.com/ewanvalentine">Patreon</a> 来支持原作者。</p>
  <br/>

<blockquote>
<p>译者仓库：</p>
<p><a href="https://github.com/fusidic/go-microsvc/">https://github.com/fusidic/go-microsvc/</a></p>
</blockquote>
<h2 id="更多请看"><a href="#更多请看" class="headerlink" title="更多请看"></a>更多请看</h2><p><strong>Article and newsletters</strong><br><a href="https://www.nginx.com/blog/introduction-to-microservices/">https://www.nginx.com/blog/introduction-to-microservices/</a><br><a href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html</a><br><a href="https://www.microservices.com/talks/">https://www.microservices.com/talks/</a><br><a href="https://medium.facilelogin.com/ten-talks-on-microservices-you-cannot-miss-at-any-cost-7bbe5ab7f43f#.ui0748oat">https://medium.facilelogin.com/ten-talks-on-microservices-you-cannot-miss-at-any-cost-7bbe5ab7f43f#.ui0748oat</a><br><a href="https://microserviceweekly.com/">https://microserviceweekly.com/</a></p>
<p><strong>Books</strong><br><a href="https://www.amazon.co.uk/Building-Microservices-Sam-Newman/dp/1491950358">https://www.amazon.co.uk/Building-Microservices-Sam-Newman/dp/1491950358</a><br><a href="https://www.amazon.co.uk/Devops-Handbook-World-Class-Reliability-Organizations/dp/1942788002">https://www.amazon.co.uk/Devops-Handbook-World-Class-Reliability-Organizations/dp/1942788002</a><br><a href="https://www.amazon.co.uk/Phoenix-Project-DevOps-Helping-Business/dp/0988262509">https://www.amazon.co.uk/Phoenix-Project-DevOps-Helping-Business/dp/0988262509</a></p>
<p><strong>Podcasts</strong><br><a href="https://softwareengineeringdaily.com/tag/microservices/">https://softwareengineeringdaily.com/tag/microservices/</a><br><a href="https://martinfowler.com/tags/podcast.html">https://martinfowler.com/tags/podcast.html</a><br><a href="https://www.infoq.com/microservices/podcasts/">https://www.infoq.com/microservices/podcasts/</a></p>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Golang/">Golang</a><a class="link-muted mr-2" rel="tag" href="/tags/Microservices/">Microservices</a><a class="link-muted mr-2" rel="tag" href="/tags/Translation/">Translation</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/04/07/ICARUS%E5%A4%87%E5%BF%98/"><span class="level-item">ICARUS备忘</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#引言"><span class="mr-2">1</span><span>引言</span></a></li><li><a class="is-flex" href="#先决条件"><span class="mr-2">2</span><span>先决条件</span></a></li><li><a class="is-flex" href="#我们要做什么？"><span class="mr-2">3</span><span>我们要做什么？</span></a></li><li><a class="is-flex" href="#什么是微服务？"><span class="mr-2">4</span><span>什么是微服务？</span></a></li><li><a class="is-flex" href="#为什么用微服务？"><span class="mr-2">5</span><span>为什么用微服务？</span></a></li><li><a class="is-flex" href="#为什么用Golang？"><span class="mr-2">6</span><span>为什么用Golang？</span></a></li><li><a class="is-flex" href="#protobuf-gRPC-简述"><span class="mr-2">7</span><span>protobuf gRPC 简述</span></a></li><li><a class="is-flex" href="#更多请看"><span class="mr-2">8</span><span>更多请看</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-07T15:52:06.000Z">2020-04-07</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/07/MicroservicesinGolangPart1/">Microservices in Golang - Part1</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a> / <a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-06T19:46:25.000Z">2020-04-07</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/07/ICARUS%E5%A4%87%E5%BF%98/">ICARUS备忘</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-03T14:53:53.000Z">2020-04-03</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/03/leetcodeQ5/">[Leetcode] Q5最长回文串</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-03-27T11:46:35.000Z">2020-03-27</time></p><p class="title is-6"><a class="link-muted" href="/2020/03/27/%E6%90%9E%E4%BA%8B/">[Golang] 自动健康上报</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-03-22T10:45:00.000Z">2020-03-22</time></p><p class="title is-6"><a class="link-muted" href="/2020/03/22/GoModBest-Practice-NotReally/">[Golang] Go Mod Best-Practice(NotReally)</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a><p class="size-small"><span>&copy; 2020 arithbar</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://fusidic.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>