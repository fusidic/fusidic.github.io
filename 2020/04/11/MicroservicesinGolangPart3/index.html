<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Microservices in Golang - Part3 - Fusidic&#039;s blog</title><meta description="内容提要：docker-compose &amp;amp; 持久化 原作者：Ewan Valentine 原文链接：https:&amp;#x2F;&amp;#x2F;ewanvalentine.io&amp;#x2F;microservices-in-golang-part-3&amp;#x2F; 引言在系列的第二章节中，我们开始使用Docker对服务进行容器化，并使用go-micro替代了gRPC，并且引入了vessel服务。本章节中我们将会使用docker-compos"><meta property="og:type" content="blog"><meta property="og:title" content="Microservices in Golang - Part3"><meta property="og:url" content="https://fusidic.github.io/"><meta property="og:site_name" content="Fusidic&#039;s blog"><meta property="og:description" content="内容提要：docker-compose &amp;amp; 持久化 原作者：Ewan Valentine 原文链接：https:&amp;#x2F;&amp;#x2F;ewanvalentine.io&amp;#x2F;microservices-in-golang-part-3&amp;#x2F; 引言在系列的第二章节中，我们开始使用Docker对服务进行容器化，并使用go-micro替代了gRPC，并且引入了vessel服务。本章节中我们将会使用docker-compos"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-04-11T10:16:06.000Z"><meta property="article:modified_time" content="2020-05-11T07:44:56.253Z"><meta property="article:author" content="arithbar"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Microservices"><meta property="article:tag" content="Translation"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://fusidic.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://fusidic.github.io/2020/04/11/MicroservicesinGolangPart3/"},"headline":"Fusidic's blog","image":["https://fusidic.github.io/img/og_image.png"],"datePublished":"2020-04-11T10:16:06.000Z","dateModified":"2020-05-11T07:44:56.253Z","author":{"@type":"Person","name":"arithbar"},"description":"内容提要：docker-compose &amp; 持久化 原作者：Ewan Valentine 原文链接：https:&#x2F;&#x2F;ewanvalentine.io&#x2F;microservices-in-golang-part-3&#x2F; 引言在系列的第二章节中，我们开始使用Docker对服务进行容器化，并使用go-micro替代了gRPC，并且引入了vessel服务。本章节中我们将会使用docker-compos"}</script><link rel="canonical" href="https://fusidic.github.io/2020/04/11/MicroservicesinGolangPart3/"><link rel="icon" href="/img/favicon.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/fusidic"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-04-11T10:16:06.000Z" title="2020-04-11T10:16:06.000Z">2020-04-11</time><span class="level-item"><a class="link-muted" href="/categories/Developments/">Developments</a><span> / </span><a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></span><span class="level-item">1 小时 读完 (大约 6943 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Microservices in Golang - Part3</h1><div class="content"><p>内容提要：docker-compose &amp; 持久化</p>
<p>原作者：Ewan Valentine</p>
<p>原文链接：<a href="https://ewanvalentine.io/microservices-in-golang-part-3/">https://ewanvalentine.io/microservices-in-golang-part-3/</a></p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在<a href="https://fusidic.github.io/2020/04/08/MicroservicesinGolangPart2/">系列的第二章节</a>中，我们开始使用Docker对服务进行容器化，并使用go-micro替代了gRPC，并且引入了vessel服务。本章节中我们将会使用<a href="https://docs.docker.com/compose/">docker-compose</a>，它能够使我们在本地运行多个服务变得更加简单，以及，我们将介绍几个不同的数据库，并且这次将迎来服务组合中的第三位成员。</p>
<p><strong>UPDATE 2020/05/02</strong></p>
<a id="more"></a>

<h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><p>请先安装 docker-compose:  <a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></p>
<br/>

<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>直到目前为止，我们的数据依然还是放在内存当中，而并没有使用数据库，当容器重启的时候，这些数据就会丢失。所以是时候选择一个方法，对数据进行持久化、存储以便查询了。</p>
<p>微服务美妙的地方就在于，你可以为不同的服务选择不同类型的数据库，当然你并不是非得这么做，事实上对于小型团队来说，维护多个数据库要比一个麻烦的多。但在某些场景之下，我们的服务中的数据，可能并不是很适合用当前的数据库来处理，所以这时，微服务的特性就提供了无限的可能。由于你的关注点是相互独立的，因此微服务使得工作变得更简单。</p>
<h3 id="SQL-还是-NoSQL-？"><a href="#SQL-还是-NoSQL-？" class="headerlink" title="SQL 还是 NoSQL ？"></a>SQL 还是 NoSQL ？</h3><p>如何为你的服务选择一个“正确的数据库“并不是本文的重点，你可以参考<a href="https://www.infoworld.com/article/3236291/database/how-to-choose-a-database-for-your-microservices.html">这篇文章</a>，所以我们不会在这个问题上过多纠结。简单来说，如果你的数据十分松散并且一致性要求不高，那么一个NoSQL类型的数据库会是一个好的选择，这种类型的数据库更加灵活，非常适合搭配JSON使用。我们会使用MongoDB作为我们的NoSQL数据库，因为它性能足够好，且使用广泛、有非常棒的社区支持。</p>
<p>当然了，如果你的数据定义很严格，且关联性更强，那么使用传统的rdbms或关系型数据库会更好。在关系型数据库的选择上，并没有什么硬性规定。但在选择数据库之前，还请务必研究下你的数据结构，考虑你的服务使读取更多还是写入更多？查询的复杂度如何？根据这些再来找一个合适的数据库。我将会选择Postgres作为我们的关系型数据库，没别的原因，只是因为我比较熟，而且它性能也不错。你完全可以用MySQL、MariaDB或者其他数据库。</p>
<p>如果你想避免自己维护数据库，那么Amazon和Google对于这两种数据库类型也都有一些出色的云端解决方案 (比较推荐这样做)。 另一个不错的选择是<a href="https://www.compose.com/">compose</a>，它对多种数据库都有良好的支持，并且有完全托管的、可扩展的实例，同时它会根据你的服务选择服务商以减少网络延迟。</p>
<p>Amazon:<br>RDBMS: <a href="https://aws.amazon.com/rds/">https://aws.amazon.com/rds/</a><br>NoSQL: <a href="https://aws.amazon.com/dynamodb/">https://aws.amazon.com/dynamodb/</a></p>
<p>Google:<br>RDBMS: <a href="https://cloud.google.com/spanner/">https://cloud.google.com/spanner/</a><br>NoSQL: <a href="https://cloud.google.com/datastore/">https://cloud.google.com/datastore/</a></p>
<br/>

<h2 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h2><p>上期我们已经了解过  <a href="https://docker.com/">Docker</a>了, 它能让我们的微服务运行在一个轻量的、拥有独立运行时和依赖的容器中。但你们大概也感觉到了，为每一个微服务都写一个 Makefile 是在是太麻烦了！不妨来看看 <a href="https://docs.docker.com/compose/">docker-compose</a> 把，看它是如何解决这个麻烦的！Docker-compose 允许我们通过一个 yaml 文件配置一系列的容器，并且你可以为每一个容器提供它们运行时 (runtime) 的元数据 (metadata)。用 docker-compose 来运行容器类似于使用我们先前使用的 docker 命令。Docker-compose或多或少地用到我们已经在使用的docker命令。 例如：</p>
<p>docker命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 50052:50051 -e MICRO_SERVER_ADDRESS=:50051 -e MICRO_REGISTRY=mdns vessel-service</span><br></pre></td></tr></table></figure>

<p>转成docker-compose：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.1'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">vessel-service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./vessel-service</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">50052</span><span class="string">:50051</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MICRO_SERVER_ADDRESS:</span> <span class="string">":50051"</span></span><br></pre></td></tr></table></figure>

<p>非常简单！</p>
<p>那我们的策略就是为每个服务都创建一个docker-compose文件，且这些服务都共享一个网络，这样它们就能作为不同的项目相互通信了。</p>
<br/>

<h3 id="容器编排"><a href="#容器编排" class="headerlink" title="容器编排"></a>容器编排</h3><p><em><a href="http://www.dockerinfo.net/4257.html">使用 docker-compose 进行容器编排</a></em></p>
<p>接下来让我们在所有项目的根目录创建一个 <code>$ touch docker-compose.yml</code> ，在其中加入我们的服务：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3.5'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consignment-service:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> <span class="comment"># ensures the container will restart on crash</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">"consignment-service"</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./consignment-service</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">50051</span> <span class="comment"># exposing this port on the docker network only, not host</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consignment-tier</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DB_HOST:</span> <span class="string">"mongodb://datastore:27017"</span></span><br><span class="line">      <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50051"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">datastore:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">"datastore"</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_DATA_DIR=/data/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MONGO_LOG_DIR=/dev/null</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/db:/data/db</span> <span class="comment"># ensures data persistence between restarting</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consignment-tier</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">mongod</span> <span class="string">--logpath=/dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">consignment-tier:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consignment-tier</span></span><br><span class="line">  <span class="attr">backend-tier:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">backend-tier</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>编者注：该文件后文中会有改动，不以此为准！</p>
</blockquote>
<p>文件开头中，我们定义了docker-compose的版本，之后则是一系列服务。还有其他的一些根级别的定义，例如网络和卷，但是我们现在仅关注服务相关的配置。</p>
<p>首先我们定义了我们的服务，包括环境变量还有其他的一些参数，之后我们定义了我们的数据库，使用的是mongodb官方镜像。</p>
<p>每个服务都以它的名字进行声明，之后是它们的编译路径，这是一个相对路径，路径中应该包含一个Dockerfile。通过后者，docker-compose可以构建服务的镜像，你也可以使用一个预先构建好的镜像放在 <code>image</code> 参数中 (我们之后会采取这种方式)。服务声明中还需要包括 <code>端口映射</code> <code>环境变量</code>.</p>
<p>之后只需使用 <code>$ dokcer-compose build</code> 就可以构建你的docker-compose栈，然后使用 <code>$ docker-compose run</code> 运行，使用 <code>$ docker-compose up -d</code> 将容器放到后台运行。在任何端点你都可以使用 <code>$docker ps</code> 查看正在运行的容器，最后，你还可以使用 <code>$ docker stop $(docker ps -qa)</code> 停止所有的容器 (别轻易这么干)。</p>
<p>最终我们创建了<strong>两个网络</strong>，一个是用于整个后端系统，另一个用于本地范围的服务。<code>bakend-tier</code> 网络使我们的服务能够连接到 <code>consignment-service</code> ，在服务和数据库之间，我们会创建一个私有网络用于通信。你并不一定非得这么做，你完全可以把这些都放到同一层网络中，但是实践中考虑网络安全是一件好事事。</p>
<br/>

<h3 id="运行一下"><a href="#运行一下" class="headerlink" title="运行一下"></a>运行一下</h3><p>接下来让我们运行一下CLI工具来检查 docker-compose 能否正常工作。使用 <code>$ docker-compose build &amp;&amp; docker-compose run</code> 来运行我们的程序，可以看到cli成功输出就再好不过了。</p>
<h3 id="consignment-service-重构"><a href="#consignment-service-重构" class="headerlink" title="consignment-service 重构"></a>consignment-service 重构</h3><p>现在我们需要来连接我们的第一个服务了—— consignment-service. 我感觉我们得先进行一些清理工作，之前我们把所有业务逻辑一股脑儿全部放到了 <code>main.go</code> 中，虽说我们写的是”微服务“，但是也没有理由写得”一团“遭。所以接下来要在 <code>consignment-service/</code> 目录中创建 <code>handler.go</code> <code>datastore.go</code> <code>repository.go</code>。注意到我是在服务的根目录中创建这些文件而不是将它们放在新路径的 <code>package</code> 中，这对一个“微服务”其实已经足够了。</p>
<blockquote>
<p>一篇关于组织Go代码仓库结构的<a href="https://rakyll.org/style-packages/">文章</a>，其实按照golang项目的风格，并不是很适合采用MVC架构，尤其是小型的golang项目，这种情况下，项目结构更多的是采用领域驱动 (Domain Driven)，而不是功能驱动。</p>
 <br/>

<p>另外需要注意一下，Golang并不建议将项目根目录中的文件作为包导入到main函数中，所以在项目编译的时候，我们需要将新增的三个文件也一起编译，在Dockerfile中对应处加入:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> CGO_ENABLED=0 GOOS=linux go build  -o consignment-service -a -installsuffix cgo main.go repository.go handler.go datastore.go</span></span><br></pre></td></tr></table></figure>
</blockquote>
<br/>

<h4 id="repository-go-与MongoDB交互"><a href="#repository-go-与MongoDB交互" class="headerlink" title="repository.go 与MongoDB交互"></a>repository.go 与MongoDB交互</h4><p>好吧，接下来可以开始删除 <code>main.go</code> 里面 repository 部分的代码，真正的开始使用mongoDB数据库了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-service/repository.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUsername&gt;/shippy-service-consignment/proto/consignment"</span></span><br><span class="line">	<span class="string">"go.mongodb.org/mongo-driver/mongo"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Consignment <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID <span class="keyword">string</span> <span class="string">`json:"id"`</span></span><br><span class="line">	Weight <span class="keyword">int32</span> <span class="string">`json:"weight"`</span></span><br><span class="line">	Description <span class="keyword">string</span> <span class="string">`json:"description"`</span></span><br><span class="line">	Containers Containers <span class="string">`json:"containers"`</span></span><br><span class="line">	VesselID <span class="keyword">string</span> <span class="string">`json:"vessel_id"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Container <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID <span class="keyword">string</span> <span class="string">`json:"id"`</span></span><br><span class="line">	CustomerID <span class="keyword">string</span> <span class="string">`json:"customer_id"`</span></span><br><span class="line">	UserID <span class="keyword">string</span> <span class="string">`json:"user_id"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Containers []*Container</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalContainerCollection</span><span class="params">(containers []*pb.Container)</span> []*<span class="title">Container</span></span> &#123;</span><br><span class="line">	collection := <span class="built_in">make</span>([]*Container, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> containers &#123;</span><br><span class="line">		collection = <span class="built_in">append</span>(collection, MarshalContainer(container))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalContainerCollection</span><span class="params">(containers []*Container)</span> []*<span class="title">pb</span>.<span class="title">Container</span></span> &#123;</span><br><span class="line">	collection := <span class="built_in">make</span>([]*pb.Container, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> containers &#123;</span><br><span class="line">		collection = <span class="built_in">append</span>(collection, UnmarshalContainer(container))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalConsignmentCollection</span><span class="params">(consignments []*Consignment)</span> []*<span class="title">pb</span>.<span class="title">Consignment</span></span> &#123;</span><br><span class="line">	collection := <span class="built_in">make</span>([]*pb.Consignment, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, consignment := <span class="keyword">range</span> consignments &#123;</span><br><span class="line">		collection = <span class="built_in">append</span>(collection, UnmarshalConsignment(consignment))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalContainer</span><span class="params">(container *Container)</span> *<span class="title">pb</span>.<span class="title">Container</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Container&#123;</span><br><span class="line">		Id: container.ID,</span><br><span class="line">		CustomerId: container.CustomerID,</span><br><span class="line">		UserId: container.UserID,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalContainer</span><span class="params">(container *pb.Container)</span> *<span class="title">Container</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Container&#123;</span><br><span class="line">		ID:         container.Id,</span><br><span class="line">		CustomerID: container.CustomerId,</span><br><span class="line">		UserID:     container.UserId,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Marshal an input consignment type to a consignment model</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalConsignment</span><span class="params">(consignment *pb.Consignment)</span> *<span class="title">Consignment</span></span> &#123;</span><br><span class="line">	containers := MarshalContainerCollection(consignment.Containers)</span><br><span class="line">	<span class="keyword">return</span> &amp;Consignment&#123;</span><br><span class="line">		ID: consignment.Id,</span><br><span class="line">		Weight: consignment.Weight,</span><br><span class="line">		Description: consignment.Description,</span><br><span class="line">		Containers: containers,</span><br><span class="line">		VesselID: consignment.VesselId,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalConsignment</span><span class="params">(consignment *Consignment)</span> *<span class="title">pb</span>.<span class="title">Consignment</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Consignment&#123;</span><br><span class="line">		Id: consignment.ID,</span><br><span class="line">		Weight: consignment.Weight,</span><br><span class="line">		Description: consignment.Description,</span><br><span class="line">		Containers: UnmarshalContainerCollection(consignment.Containers),</span><br><span class="line">		VesselId: consignment.VesselID,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	Create(ctx context.Context, consignment *Consignment) error</span><br><span class="line">	GetAll(ctx context.Context) ([]*Consignment, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MongoRepository implementation</span></span><br><span class="line"><span class="keyword">type</span> MongoRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">	collection *mongo.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create -</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repository *MongoRepository)</span> <span class="title">Create</span><span class="params">(ctx context.Context, consignment *Consignment)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := repository.collection.InsertOne(ctx, consignment)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAll -</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repository *MongoRepository)</span> <span class="title">GetAll</span><span class="params">(ctx context.Context)</span> <span class="params">([]*Consignment, error)</span></span> &#123;</span><br><span class="line">	cur, err := repository.collection.Find(ctx, <span class="literal">nil</span>, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">var</span> consignments []*Consignment</span><br><span class="line">	<span class="keyword">for</span> cur.Next(ctx) &#123;</span><br><span class="line">		<span class="keyword">var</span> consignment *Consignment</span><br><span class="line">		<span class="keyword">if</span> err := cur.Decode(&amp;consignment); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		consignments = <span class="built_in">append</span>(consignments, consignment)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> consignments, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<p>这就是与MongoDB数据库交互的代码了，这里用到了 <code>marshalling</code> 与 <code>unmarshalling</code> 函数，它们主要用于 “protobuf 声明生成的数据结构” 与代码内置的数据模型之间的转换。理论上你可以使用生成的数据结构直接作为你的数据模型，但从软件设计的角度来看，我们并不推荐这种行为，因为这会造成数据模型和交付层之间的耦合度过高。更好的方法是在软件的各个功能结构之间保持隔离，看起来似乎会造成一些额外的开销，但为了保证软件的可扩展性，这种操作是非常必要的。</p>
<br/>

<h4 id="datastore-go-创建连接"><a href="#datastore-go-创建连接" class="headerlink" title="datastore.go 创建连接"></a>datastore.go 创建连接</h4><p>*<em>编写用于创建 “会话/连接” *</em>的代码，更新 <code>consignment-service/datastore.go</code> 中的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-service/datastore.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"go.mongodb.org/mongo-driver/mongo"</span></span><br><span class="line">	<span class="string">"go.mongodb.org/mongo-driver/mongo/options"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateClient -</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateClient</span><span class="params">(ctx context.Context, uri <span class="keyword">string</span>, retry <span class="keyword">int32</span>)</span> <span class="params">(*mongo.Client, error)</span></span> &#123;</span><br><span class="line">	conn, err := mongo.Connect(ctx, options.Client().ApplyURI(uri))</span><br><span class="line">	<span class="keyword">if</span> err := conn.Ping(ctx, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> retry &gt;= <span class="number">3</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		retry = retry + <span class="number">1</span></span><br><span class="line">		time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">		<span class="keyword">return</span> CreateClient(ctx, uri, retry)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> conn, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我们首先使用url字符串创建了一个连接，接下来通过 <code>ping</code> 一下连接，确认一下与数据库的连接是否正常。我们设置了一些基本的“重试”逻辑：如果连接失败，就再试一次，当重试次数超过了三次，就会报一个错误，并等待处理。</p>
<br/>

<h4 id="重构-main-go"><a href="#重构-main-go" class="headerlink" title="重构 main.go"></a>重构 main.go</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-service/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	pb <span class="string">"github.com/fusidic/consignment-service/proto/consignment"</span></span><br><span class="line">	vesselProto <span class="string">"github.com/fusidic/vessel-service/proto/vessel"</span></span><br><span class="line">	<span class="string">"github.com/micro/go-micro"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	defaultHost = <span class="string">"datastore:27017"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Set-up micro instance</span></span><br><span class="line">	srv := micro.NewService(</span><br><span class="line">		micro.Name(<span class="string">"shippy.service.consignment"</span>),</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	srv.Init()</span><br><span class="line"></span><br><span class="line">	uri := os.Getenv(<span class="string">"DB_HOST"</span>)</span><br><span class="line">	<span class="keyword">if</span> uri == <span class="string">""</span> &#123;</span><br><span class="line">		uri = defaultHost</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client, err := CreateClient(context.Background(), uri, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> client.Disconnect(context.Background())</span><br><span class="line"></span><br><span class="line">	consignmentCollection := client.Database(<span class="string">"shippy"</span>).Collection(<span class="string">"consignments"</span>)</span><br><span class="line"></span><br><span class="line">	repository := &amp;MongoRepository&#123;consignmentCollection&#125;</span><br><span class="line">	vesselClient := vesselProto.NewVesselServiceClient(<span class="string">"shippy.service.client"</span>, srv.Client())</span><br><span class="line">	h := &amp;handler&#123;repository, vesselClient&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register handlers</span></span><br><span class="line">	pb.RegisterShippingServiceHandler(srv.Server(), h)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Run the server</span></span><br><span class="line">	<span class="keyword">if</span> err := srv.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h4 id="handler-go-处理服务请求"><a href="#handler-go-处理服务请求" class="headerlink" title="handler.go 处理服务请求"></a>handler.go 处理服务请求</h4><p>最后一件事就是将我们<strong>响应gRPC调用的处理函数移到 <code>handler.go</code> 中：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// consignment-service/handler.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"github.com/pkg/errors"</span></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUsername&gt;/shippy-service-consignment/proto/consignment"</span></span><br><span class="line">	vesselProto <span class="string">"github.com/&lt;YourUsername&gt;/shippy-service-vessel/proto/vessel"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> handler <span class="keyword">struct</span> &#123;</span><br><span class="line">	repository</span><br><span class="line">	vesselClient vesselProto.VesselServiceClient</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateConsignment - we created just one method on our service,</span></span><br><span class="line"><span class="comment">// which is a create method, which takes a context and a request as an</span></span><br><span class="line"><span class="comment">// argument, these are handled by the gRPC server.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *handler)</span> <span class="title">CreateConsignment</span><span class="params">(ctx context.Context, req *pb.Consignment, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Here we call a client instance of our vessel service with our consignment weight,</span></span><br><span class="line">	<span class="comment">// and the amount of containers as the capacity value</span></span><br><span class="line">	vesselResponse, err := s.vesselClient.FindAvailable(ctx, &amp;vesselProto.Specification&#123;</span><br><span class="line">		MaxWeight: req.Weight,</span><br><span class="line">		Capacity: <span class="keyword">int32</span>(<span class="built_in">len</span>(req.Containers)),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> vesselResponse == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"error fetching vessel, returned nil"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We set the VesselId as the vessel we got back from our</span></span><br><span class="line">	<span class="comment">// vessel service</span></span><br><span class="line">	req.VesselId = vesselResponse.Vessel.Id</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save our consignment</span></span><br><span class="line">	<span class="keyword">if</span> err = s.repository.Create(ctx, MarshalConsignment(req)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res.Created = <span class="literal">true</span></span><br><span class="line">	res.Consignment = req</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetConsignments -</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *handler)</span> <span class="title">GetConsignments</span><span class="params">(ctx context.Context, req *pb.GetRequest, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	consignments, err := s.repository.GetAll(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Consignments = UnmarshalConsignmentCollection(consignments)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="vessel-service-重构"><a href="#vessel-service-重构" class="headerlink" title="vessel-service 重构"></a>vessel-service 重构</h3><p>完成这些之后，对 <code>vessel-service</code> 也进行这样的重构，篇幅有限，我不会在这篇文章中将 <code>vessel</code> 部分完整写出来，相信到了这个时候，你应该已经有能力完成这件事了。(也可以偷偷看一眼 <a href="https://github.com/EwanValentine/shippy-service-vessel">my repository</a> )</p>
<p>哦，对了，我们还需要在 <code>vessel-service</code> 里面加入一个新的方法，让我们能够创建新的 <code>vessel</code>. 首先，还是先更新 protobuf 声明：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> vessel;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">VesselService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> FindAvailable(Specification) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">  <span class="keyword">rpc</span> Create(Vessel) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message Vessel &#123;</span></span><br><span class="line"><span class="function">  string id = 1</span>;</span><br><span class="line">  <span class="built_in">int32</span> capacity = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> max_weight = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">bool</span> available = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">string</span> owner_id = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> capacity = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> max_weight = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">  Vessel vessel = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">repeated</span> Vessel vessels = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">bool</span> created = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新增货轮-Create"><a href="#新增货轮-Create" class="headerlink" title="新增货轮 Create()"></a>新增货轮 Create()</h4><p>其中我们在gRPC服务中创建了一个 <code>Create</code> 方法，该方法接受一个 vessel 参数，返回一个通用Response。同时我们也在Response中加入了一个布尔值 created。重新生成一下，现在我们要做的就是添加一个处理程序 <code>vessel-service/handler.go</code> 和一个新的repository中的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vessel-service/handler.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	pb <span class="string">"github.com/&lt;YourUsername&gt;/shippy-service-vessel/proto/vessel"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> handler <span class="keyword">struct</span> &#123;</span><br><span class="line">	repository</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FindAvailable vessels</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *handler)</span> <span class="title">FindAvailable</span><span class="params">(ctx context.Context, req *pb.Specification, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find the next available vessel</span></span><br><span class="line">	vessel, err := s.repository.FindAvailable(ctx, MarshalSpecification(req))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the vessel as part of the response message type</span></span><br><span class="line">	res.Vessel = UnmarshalVessel(vessel)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new vessel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *handler)</span> <span class="title">Create</span><span class="params">(ctx context.Context, req *pb.Vessel, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := s.repository.Create(ctx, MarshalVessel(req)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Vessel = req</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h4 id="repository-go-与数据库连接"><a href="#repository-go-与数据库连接" class="headerlink" title="repository.go 与数据库连接"></a>repository.go 与数据库连接</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vessel-service/repository.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	pb <span class="string">"github.com/EwanValentine/shippy-service-vessel/proto/vessel"</span></span><br><span class="line">	<span class="string">"go.mongodb.org/mongo-driver/bson"</span></span><br><span class="line">	<span class="string">"go.mongodb.org/mongo-driver/mongo"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	FindAvailable(ctx context.Context, spec *Specification) (*Vessel, error)</span><br><span class="line">	Create(ctx context.Context, vessel *Vessel) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> VesselRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">	collection *mongo.Collection</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Specification <span class="keyword">struct</span> &#123;</span><br><span class="line">	Capacity <span class="keyword">int32</span></span><br><span class="line">	MaxWeight <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalSpecification</span><span class="params">(spec *pb.Specification)</span> *<span class="title">Specification</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Specification&#123;</span><br><span class="line">		Capacity: spec.Capacity,</span><br><span class="line">		MaxWeight: spec.MaxWeight,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalSpecification</span><span class="params">(spec *Specification)</span> *<span class="title">pb</span>.<span class="title">Specification</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Specification&#123;</span><br><span class="line">		Capacity: spec.Capacity,</span><br><span class="line">		MaxWeight: spec.MaxWeight,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalVessel</span><span class="params">(vessel *pb.Vessel)</span> *<span class="title">Vessel</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Vessel&#123;</span><br><span class="line">		ID: vessel.Id,</span><br><span class="line">		Capacity: vessel.Capacity,</span><br><span class="line">		MaxWeight: vessel.MaxWeight,</span><br><span class="line">		Name: vessel.Name,</span><br><span class="line">		Available: vessel.Available,</span><br><span class="line">		OwnerID: vessel.OwnerId,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalVessel</span><span class="params">(vessel *Vessel)</span> *<span class="title">pb</span>.<span class="title">Vessel</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;pb.Vessel&#123;</span><br><span class="line">		Id: vessel.ID,</span><br><span class="line">		Capacity: vessel.Capacity,</span><br><span class="line">		MaxWeight: vessel.MaxWeight,</span><br><span class="line">		Name: vessel.Name,</span><br><span class="line">		Available: vessel.Available,</span><br><span class="line">		OwnerId: vessel.OwnerID,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Vessel <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID <span class="keyword">string</span></span><br><span class="line">	Capacity <span class="keyword">int32</span></span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">	Available <span class="keyword">bool</span></span><br><span class="line">	OwnerID <span class="keyword">string</span></span><br><span class="line">	MaxWeight <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FindAvailable - 根据规格清单检查船只，从货船列表中找到一个容量和载重量都符合标准的船</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repository *VesselRepository)</span> <span class="title">FindAvailable</span><span class="params">(ctx context.Context, spec *Specification)</span> <span class="params">(*Vessel, error)</span></span> &#123;</span><br><span class="line">	filter := bson.D&#123;&#123;</span><br><span class="line">		<span class="string">"capacity"</span>,</span><br><span class="line">		bson.D&#123;&#123;</span><br><span class="line">			<span class="string">"$lte"</span>,</span><br><span class="line">			spec.Capacity,</span><br><span class="line">		&#125;, &#123;</span><br><span class="line">			<span class="string">"$lte"</span>,</span><br><span class="line">			spec.MaxWeight,</span><br><span class="line">		&#125;&#125;,</span><br><span class="line">	&#125;&#125;</span><br><span class="line">	vessel := &amp;Vessel&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := repository.collection.FindOne(ctx, filter).Decode(vessel); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> vessel, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a new vessel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repository *VesselRepository)</span> <span class="title">Create</span><span class="params">(ctx context.Context, vessel *Vessel)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := repository.collection.InsertOne(ctx, vessel)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>终于我们可以创建 vessel 了！我已经更新了主函数，调用 Create() 方法保存数据，<a href="https://github.com/EwanValentine/shippy-service-vessel/blob/568e51dd7413743cf7d5a24ec000836e00493948/main.go">看这里</a></p>
<br/>

<p>经过一些努力，我们终于用上了 MongoDB，在我们尝试运行之前，需要更新一下 <code>docker-compose</code> 文件</p>
<blockquote>
<p>编者注：由于作者的文章经过几个版本更新，其实前文已经添加了 datastore 部分。</p>
</blockquote>
<p><code>datastore</code> 的环境变量中，使用 <code>DB_HOST: &quot;mongodb://datastore:27017&quot;</code> ，<strong>注意我们现在使用 <code>datastore</code> 作为主机名，而不是 <code>localhost</code> ，这是由于 docker-compose 能够只能处理内部的DNS请求。</strong></p>
<p>*<em>更新后的 <code>docker-compose.yml</code> : *</em></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">consignment-service:</span></span><br><span class="line">        <span class="attr">build:</span> <span class="string">./consignment-service</span></span><br><span class="line">        <span class="attr">links:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">50051</span><span class="string">:50051</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">consignment-tier</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50051"</span></span><br><span class="line">            <span class="attr">MICRO_REGISTRY:</span> <span class="string">"mdns"</span></span><br><span class="line">            <span class="attr">DB_HOST:</span> <span class="string">"mongodb://datastore:27017"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">vessel-service:</span></span><br><span class="line">        <span class="attr">build:</span> <span class="string">./vessel-service</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">50052</span><span class="string">:50051</span></span><br><span class="line">        <span class="attr">links:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">datastore</span></span><br><span class="line">        <span class="attr">networks:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vessel-tier</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50052"</span></span><br><span class="line">            <span class="attr">MICRO_REGISTRY:</span> <span class="string">"mdns"</span></span><br><span class="line">            <span class="attr">DB_HOST:</span> <span class="string">"mongodb://datastore:27017"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">user-service:</span></span><br><span class="line">        <span class="attr">build:</span> <span class="string">./user-service</span></span><br><span class="line">        <span class="attr">links:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">50053</span><span class="string">:50051</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">user-tier</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50053"</span></span><br><span class="line">            <span class="attr">MICRO_REGISTRY:</span> <span class="string">"mdns"</span></span><br><span class="line">            <span class="attr">DB_NAME:</span> <span class="string">"postgres"</span></span><br><span class="line">            <span class="attr">DB_HOST:</span> <span class="string">"database"</span></span><br><span class="line">            <span class="attr">DB_PORT:</span> <span class="string">"5432"</span></span><br><span class="line">            <span class="attr">DB_USER:</span> <span class="string">"postgres"</span></span><br><span class="line">            <span class="attr">DB_PASSWORD:</span> <span class="string">"postgres"</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">user-cli:</span></span><br><span class="line">        <span class="attr">build:</span> <span class="string">./user-cli</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">MICRO_REGISTRY:</span> <span class="string">"mdns"</span></span><br><span class="line">        <span class="attr">networks:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">user-tier</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attr">datastore:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mongo</span></span><br><span class="line">        <span class="attr">networks:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">vessel-tier</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">consignment-tier</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">27017</span><span class="string">:27017</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">database:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">POSTGRES_USER:</span> <span class="string">'postgres'</span></span><br><span class="line">            <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">'postgres'</span></span><br><span class="line">            <span class="attr">POSTGRESS_DB:</span> <span class="string">'postgres'</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">user-tier</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">    <span class="attr">consignment-tier:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">consignment-tier</span></span><br><span class="line">    <span class="attr">user-tier:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">user-tier</span></span><br><span class="line">    <span class="attr">vessel-tier:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">vessel-tier</span></span><br><span class="line">    <span class="attr">backend-tier:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">backend-tier</span></span><br></pre></td></tr></table></figure>

<br/>

<p><code>$ docker-compose build &amp;&amp; docker-compose up</code> ，<em>注意：由于Docker的缓存逻辑，所以有时你需要使用无缓存编译 <code>--no-cache</code> ，这样使你的最新改动生效。</em></p>
<br/>

<h2 id="User-service"><a href="#User-service" class="headerlink" title="User service"></a>User service</h2><p><strong>第三个服务</strong>，首先在 <code>docker-compose.yml</code> 里加上 user-service 的内容(顺便加上 Postgres 数据库)：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"> <span class="attr">user-service:</span></span><br><span class="line">   <span class="attr">build:</span> <span class="string">./shippy-service-user</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">50053</span><span class="string">:50051</span></span><br><span class="line">   <span class="attr">environment:</span></span><br><span class="line">     <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50051"</span></span><br><span class="line"></span><br><span class="line"> <span class="string">...</span></span><br><span class="line"> <span class="attr">database:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br></pre></td></tr></table></figure>

<p>现在再新建 <code>user-service</code> 的路径 (根目录下) ，就像之前的操作一样，并在新目录中创建</p>
<p><code>handler.go  main.go  repository.go  database.go  Dockerfile  Makefile  proto/user/user.proto</code></p>
<br/>

<h3 id="user-proto"><a href="#user-proto" class="headerlink" title="user.proto"></a>user.proto</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> user;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Create(User) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">    <span class="keyword">rpc</span> Get(User) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">    <span class="keyword">rpc</span> GetAll(Request) <span class="keyword">returns</span> (Response) &#123;&#125;</span></span><br><span class="line"><span class="function">    <span class="keyword">rpc</span> Auth(User) <span class="keyword">returns</span> (Token) &#123;&#125;</span></span><br><span class="line"><span class="function">    <span class="keyword">rpc</span> ValidateToken(Token) <span class="keyword">returns</span> (Token) &#123;&#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message User &#123;</span></span><br><span class="line"><span class="function">    string id = 1</span>;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">string</span> company = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">string</span> email = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">string</span> password = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Request</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    User user = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> User users = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">repeated</span> Error errors = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Token</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> token = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">bool</span> valid = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">repeated</span> Error errors = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="built_in">int32</span> code = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> description = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>类似之前的，相信你可以写出来。使用 <code>$ make build</code> 生成 gRPC 代码。</p>
<br/>

<h3 id="handler-go"><a href="#handler-go" class="headerlink" title="handler.go"></a>handler.go</h3><p>在先前的服务中，我们已经创建了一些代码来连接gRPC中的方法。 这篇文章，我们只实现 <code>user.proto</code> 三种方法中的一部分 —— 我们只希望能够创建和获取用户。 在本系列的下一篇文章中，我们将研究身份验证和JWT。 因此，我们暂时将保留所有与 token(令牌) 相关的内容。 <code>handler.go</code> 如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user-service/handler.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	pb <span class="string">"github.com/fusidic/user-service/proto/user"</span></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">	repo Repository</span><br><span class="line">  <span class="comment">// 下一章会使用JWT认证</span></span><br><span class="line">	<span class="comment">// tokenService Authable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *service)</span> <span class="title">Get</span><span class="params">(ctx context.Context, req *pb.User, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	user, err := srv.repo.Get(ctx, req.Id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.User = user</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *service)</span> <span class="title">GetAll</span><span class="params">(ctx context.Context, req *pb.Request, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	users, err := srv.repo.GetAll(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Users = users</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *service)</span> <span class="title">Auth</span><span class="params">(ctx context.Context, req *pb.User, res *pb.Token)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := srv.repo.GetByEmailAndPassword(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Token = <span class="string">"testingabc"</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *service)</span> <span class="title">Create</span><span class="params">(ctx context.Context, req *pb.User, res *pb.Response)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := srv.repo.Create(req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	res.User = req</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *service)</span> <span class="title">ValidateToken</span><span class="params">(ctx context.Context, req *pb.Token, res *pb.Token)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="repository-go"><a href="#repository-go" class="headerlink" title="repository.go"></a>repository.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user-service/repository.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	pb <span class="string">"github.com/fusidic/user-service/proto/user"</span></span><br><span class="line">	<span class="string">"github.com/jinzhu/gorm"</span></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Repository ...</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">interface</span> &#123;</span><br><span class="line">	GetAll(ctx context.Context) ([]*pb.User, error)</span><br><span class="line">	Get(ctx context.Context, id <span class="keyword">string</span>) (*pb.User, error)</span><br><span class="line">	Create(user *pb.User) error</span><br><span class="line">	GetByEmailAndPassword(user *pb.User) (*pb.User, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserRepository ...</span></span><br><span class="line"><span class="keyword">type</span> UserRepository <span class="keyword">struct</span> &#123;</span><br><span class="line">	db *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAll ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *UserRepository)</span> <span class="title">GetAll</span><span class="params">(ctx context.Context)</span> <span class="params">([]*pb.User, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> users []*pb.User</span><br><span class="line">	<span class="keyword">if</span> err := repo.db.Find(&amp;users).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> users, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *UserRepository)</span> <span class="title">Get</span><span class="params">(ctx context.Context, id <span class="keyword">string</span>)</span> <span class="params">(*pb.User, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> user *pb.User</span><br><span class="line">	user.Id = id</span><br><span class="line">	<span class="keyword">if</span> err := repo.db.First(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetByEmailAndPassword ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *UserRepository)</span> <span class="title">GetByEmailAndPassword</span><span class="params">(user *pb.User)</span> <span class="params">(*pb.User, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := repo.db.First(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(repo *UserRepository)</span> <span class="title">Create</span><span class="params">(user *pb.User)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := repo.db.Create(user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="extension-go"><a href="#extension-go" class="headerlink" title="extension.go"></a>extension.go</h3><p>我们也需要修改一下 ORM 的行为，需要在 ORM 创建的时候生成一个 <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> ，而不是使用内置的ID。以防你不知道，这里简单介绍下 <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a>：UUID 是随机生成的一个集合，其元素都是用 ’-‘ 串联的字符串，被用于当作ID或者主键，相比自增的ID，UUID更加安全，因为它能够防止人们猜到或者追踪到你的 API 端点。MongoDB 中用到了UUID的一个差异版本，而在 Postgres 中我们需要告知其启用 UUID。所以在 <code>user-service/proto/user</code> 中，需要创建一个 <code>extensions.go</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> user</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/jinzhu/gorm"</span></span><br><span class="line">	<span class="string">"github.com/satori/go.uuid"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(model *User)</span> <span class="title">BeforeCreate</span><span class="params">(scope *gorm.Scope)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	uuid := uuid.NewV4()</span><br><span class="line">	<span class="keyword">return</span> scope.SetColumn(<span class="string">"Id"</span>, uuid.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序深入到了 GORM 的生命周期中，在每个实体创建之前，给它生成一个 UUID。</p>
<p>你可能会注意到，不像是 MongoDB，我们在这里不需要处理任何关于连接的操作。原生的 SQL/postgres 驱动有着和 MongoDB 不一样的行为模式，这次我们不需要去管这些事情。现在让我们稍微了解下用到的 <code>gorm</code> 库。</p>
<br/>

<blockquote>
<p>UPDATE 2020/04/20</p>
<p>译者注：</p>
<p>更多请参考 <a href="https://github.com/EwanValentine/shippy/blob/tutorial-3/user-service/">https://github.com/EwanValentine/shippy/blob/tutorial-3/user-service/</a></p>
</blockquote>
<h2 id="Gorm-Go-ORM"><a href="#Gorm-Go-ORM" class="headerlink" title="Gorm - Go + ORM"></a>Gorm - Go + ORM</h2><p><a href="http://jinzhu.me/gorm/">Gorm</a> 是一个非常轻量的对象关系映射 (ORM, Object-Relational Mapping)，非常适合 Postgers、MySQL、Sqlite等类型的数据库。他可以生成数据库样式，并很轻松地使用、管理这些样式。</p>
<p>话虽如此，但是作为微服务，数据结构更小、结构更简单，所以也不一定需要用到任何形式的 ORM。</p>
<p>我们需要测试一下“添加用户”的功能，所以需要创建另一个CLI工具 <code>user-cli</code> ，和之前的 <code>consignment-cli</code> 类似：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user-cli/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	pb <span class="string">"github.com/EwanValentine/shippy/user-service/proto/user"</span></span><br><span class="line">	microclient <span class="string">"github.com/micro/go-micro/client"</span></span><br><span class="line">	<span class="string">"github.com/micro/go-micro/cmd"</span></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">	<span class="string">"github.com/micro/cli"</span></span><br><span class="line">	<span class="string">"github.com/micro/go-micro"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cmd.Init()</span><br><span class="line">	<span class="comment">// Create new greeter client</span></span><br><span class="line">	client := pb.NewUserServiceClient(<span class="string">"user"</span>, microclient.DefaultClient)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Define our flags</span></span><br><span class="line">	service := micro.NewService(</span><br><span class="line">		micro.Flags(</span><br><span class="line">			cli.StringFlag&#123;</span><br><span class="line">				Name:  <span class="string">"name"</span>,</span><br><span class="line">				Usage: <span class="string">"You full name"</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			cli.StringFlag&#123;</span><br><span class="line">				Name:  <span class="string">"email"</span>,</span><br><span class="line">				Usage: <span class="string">"Your email"</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			cli.StringFlag&#123;</span><br><span class="line">				Name:  <span class="string">"password"</span>,</span><br><span class="line">				Usage: <span class="string">"Your password"</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			cli.StringFlag&#123;</span><br><span class="line">				Name: <span class="string">"company"</span>,</span><br><span class="line">				Usage: <span class="string">"Your company"</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">		),</span><br><span class="line">	)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start as service</span></span><br><span class="line">	service.Init(</span><br><span class="line">		micro.Action(<span class="function"><span class="keyword">func</span><span class="params">(c *cli.Context)</span></span> &#123;</span><br><span class="line">			name := c.String(<span class="string">"name"</span>)</span><br><span class="line">			email := c.String(<span class="string">"email"</span>)</span><br><span class="line">			password := c.String(<span class="string">"password"</span>)</span><br><span class="line">			company := c.String(<span class="string">"company"</span>)</span><br><span class="line">            <span class="comment">// Call our user service</span></span><br><span class="line">			r, err := client.Create(context.TODO(), &amp;pb.User&#123;</span><br><span class="line">				Name: name,</span><br><span class="line">				Email: email,</span><br><span class="line">				Password: password,</span><br><span class="line">				Company: company,</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">"Could not create: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			log.Printf(<span class="string">"Created: %s"</span>, r.User.Id)</span><br><span class="line">			getAll, err := client.GetAll(context.Background(), &amp;pb.Request&#123;&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">"Could not list users: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> _, v := <span class="keyword">range</span> getAll.Users &#123;</span><br><span class="line">				log.Println(v)</span><br><span class="line">			&#125;</span><br><span class="line">			os.Exit(<span class="number">0</span>)</span><br><span class="line">		&#125;),</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// Run the server</span></span><br><span class="line">	<span class="keyword">if</span> err := service.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose run user-cli <span class="built_in">command</span> \</span><br><span class="line">  --name=<span class="string">"Ewan Valentine"</span> \</span><br><span class="line">  --email=<span class="string">"ewan.valentine89@gmail.com"</span> \</span><br><span class="line">  --password=<span class="string">"Testing123"</span> \</span><br><span class="line">  --company=<span class="string">"BBC"</span></span><br></pre></td></tr></table></figure>

<p>应该能看到被创建的用户了！</p>
<p>使用 <code>$ docker-compose run database bash</code> 可以进入容器 shell 中查看数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose run database bash</span><br><span class="line">database<span class="comment"># psql --host=database --username=postgres --dbname=postgres</span></span><br><span class="line">Password <span class="keyword">for</span> user unicorn_user: </span><br><span class="line">psql (12.0 (Debian 12.0-2.pgdg100+1))</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># select * from users;</span></span><br></pre></td></tr></table></figure>



<p>创建的过程不是很安全，因为我们是明文保存密码，下一章中我们会看一下微服务中的<strong>认证</strong>和<strong>鉴权</strong> JWT 该怎么做。</p>
<br/>

<p>总结一下，经过第三篇文章的学习，我们创建了一个新的微服务和CLI工具，并且我们还使用到了两种数据库技术来保存我们的数据。这节涉及到的内容比较多，如果你觉得讲的内容太多太快，我在这里报以歉意。请在项目仓库中向我提出建议，或者给我<a href="ewan.valentine89@gmail.com">反馈</a>!</p>
<br/>

<p>觉得这系列文章对您有帮助，可以请原作者喝杯咖啡，Cheers! <a href="https://monzo.me/ewanvalentine">https://monzo.me/ewanvalentine</a>.</p>
<p>或者通过 <a href="https://www.patreon.com/ewanvalentine">Patreon</a> 来支持原作者。</p>
<br/>

<p><strong>UPDATE 2020/05/01</strong></p>
<h2 id="Troubleshoot"><a href="#Troubleshoot" class="headerlink" title="Troubleshoot"></a>Troubleshoot</h2><p>由于作者文章是两年前所写，因此有许多内容在当前已经有所变化，也导致程序出现了一些问题，以下为译者对一些问题的修复。</p>
<ul>
<li>运行 <code>consignment-service</code> 时报错：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">I | server selection error: server selection timeout, current topology: &#123; Type: Unknown, Servers: [&#123; Addr: datastore:27017, Type: Unknown, State: Connected, Average RTT: 0, Last error: connection() : dial tcp: lookup datastore on 127.0.0.11:53: no such host &#125;, ] &#125;</span><br><span class="line"></span><br><span class="line">panic: server selection error: server selection timeout, current topology: &#123; Type: Unknown, Servers: [&#123; Addr: datastore:27017, Type: Unknown, State: Connected, Average RTT: 0, Last error: connection() : dial tcp: lookup datastore on 127.0.0.11:53: no such host &#125;, ] &#125;</span><br></pre></td></tr></table></figure>

<p>显然 <code>consignment</code> 服务没法与 <code>datastore</code> 建立连接，这是由于两个服务容器未互相关联引起的，可以在 <code>consignment-service</code> 中加入 <code>depends_on: datastore</code> 这样一条属性。</p>
<br/>

<ul>
<li>空引用问题，运行 <code>consignment-service</code> 等的报错信息：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">panic: runtime error: invalid memory address or nil pointer dereference</span><br><span class="line">[signal SIGSEGV: segmentation violation code=0x1 addr=0x2d0 pc=0xf1059c]</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">go.mongodb.org/mongo-driver/mongo.(*Client).Ping(0x0, 0x1469ec0, 0xc000128000, 0x0, 0x1, 0x0)</span><br><span class="line">        /go/pkg/mod/go.mongodb.org/mongo-driver@v1.3.2/mongo/client.go:231 +0x21c</span><br><span class="line">main.CreateClient(0x1469ec0, 0xc000128000, 0xc000040068, 0xf, 0xc000000000, 0xf39b27, 0x12243ac, 0x1d)</span><br><span class="line">        /app/datastore.go:15 +0x119</span><br><span class="line">main.main()</span><br><span class="line">        /app/main.go:35 +0x133</span><br></pre></td></tr></table></figure>

<p>可以看到，问题是出现在 <code>CreateClient</code> 函数中，这是由于未正确定义 <code>DB_HOST</code> 地址引起的，应该使用 <code>DB_HOST: &quot;mongodb://datastore:27017&quot;</code></p>
<br/>

<ul>
<li><code>networks</code> 网络配置错误：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: The Compose file <span class="string">'./docker-compose.yml'</span> is invalid because:</span><br><span class="line">networks.backend-tier value Additional properties are not allowed (<span class="string">'name'</span> was unexpected)</span><br></pre></td></tr></table></figure>

<p>由于 <code>name</code> 是在 <code>docker-compose</code> 3.5版本之后加入的功能，因此如果出现这样的错误，需要更新一下当前 <code>docker-compose</code> 的版本 (注意正在运行的服务可能会受到影响) 。</p>
<ol>
<li><p>下载当前版本 (1.25.5) 的 <code>docker-compose</code>:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.25.5/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可以通过替换 <code>1.25.5</code>来指定 <code>docker-compose</code> 的版本</p>
</blockquote>
</li>
<li><p>赋予可执行权限:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立链接:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ln -s /usr/<span class="built_in">local</span>/bin/docker-compose /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看版本:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose --version</span><br></pre></td></tr></table></figure>

</li>
</ol>
<br/>


<ul>
<li><p>运行 <code>user-service</code> 报错:  <code>Could not connect to DB: dial tcp: lookup database on 127.0.0.11:53: no such host</code>，原因可能是为将 <code>user-service</code> 与 <code>database</code> 定义到同一网络中，也可能是由于 <code>Postgres://database</code> 没有正确的初始化的缘故：</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">database:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="comment"># 注意对数据库进行初始化</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">POSTGRES_USER:</span> <span class="string">'postgres'</span></span><br><span class="line">        <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">'postgres'</span></span><br><span class="line">        <span class="attr">POSTGRESS_DB:</span> <span class="string">'postgres'</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">user-tier</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br><span class="line">        </span><br><span class="line"><span class="attr">user-service:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./user-service</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">50053</span><span class="string">:50051</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">backend-tier</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">user-tier</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">MICRO_ADDRESS:</span> <span class="string">":50053"</span></span><br><span class="line">        <span class="attr">MICRO_REGISTRY:</span> <span class="string">"mdns"</span></span><br><span class="line">        <span class="attr">DB_NAME:</span> <span class="string">"postgres"</span></span><br><span class="line">        <span class="attr">DB_HOST:</span> <span class="string">"database"</span></span><br><span class="line">        <span class="attr">DB_PORT:</span> <span class="string">"5432"</span></span><br><span class="line">        <span class="attr">DB_USER:</span> <span class="string">"postgres"</span></span><br><span class="line">        <span class="attr">DB_PASSWORD:</span> <span class="string">"postgres"</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<br/>

<ul>
<li><p><code>user-cli</code> 中捕获错误 </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-05-02 14:53:09.088479 I | Could not create: &#123;<span class="string">"id"</span>:<span class="string">"go.micro.client"</span>,<span class="string">"code"</span>:408,<span class="string">"detail"</span>:<span class="string">"call timeout: context deadline exceeded"</span>,<span class="string">"status"</span>:<span class="string">"Request Timeout"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>  <code>docker-compose down</code> 关闭所有服务，移除容器、网络等之后，重新运行服务，解决了这个问题</p>
</li>
</ul>
<br/>

<ul>
<li><p><code>micro/cmd</code> <code>flag</code> 参数始终无法传入，<strong>待解决</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@left3:~/workspace/go docker-compose run user-cli <span class="built_in">command</span> --name <span class="built_in">test</span> --email <span class="built_in">test</span>@test.com --password testword --company TEST.Inc</span><br><span class="line">2020-05-03 01:29:41.721090 I | unlucky :( name:blank email:<span class="built_in">test</span>@blank password:blank company:BLANK</span><br><span class="line">2020-05-03 01:29:41.831990 I | Created: f7ba601a-2703-488d-a2b6-d2b91c7b3793</span><br><span class="line">2020-05-03 01:29:41.834034 I | id:<span class="string">"ae063eb1-5900-4a7b-8632-c190f105a213"</span> </span><br><span class="line">2020-05-03 01:29:41.834081 I | id:<span class="string">"d9e1dcd4-208b-4a74-ad4c-284b6a8ae59b"</span> name:<span class="string">"blank"</span> company:<span class="string">"BLANK"</span> email:<span class="string">"test@blank"</span> password:<span class="string">"blank"</span> </span><br><span class="line">2020-05-03 01:29:41.834102 I | id:<span class="string">"8519d1a4-7b7e-4e9b-9ee5-d821ca126bb3"</span> name:<span class="string">"blank"</span> company:<span class="string">"BLANK"</span> email:<span class="string">"test@blank"</span> password:<span class="string">"blank"</span> </span><br><span class="line">2020-05-03 01:29:41.834121 I | id:<span class="string">"a2398cf2-b0ba-4a22-bb3d-8cbb6335cd6a"</span> name:<span class="string">"blank"</span> company:<span class="string">"BLANK"</span> email:<span class="string">"test@blank"</span> password:<span class="string">"blank"</span></span><br></pre></td></tr></table></figure>

<p>  无奈只能加入了一个判断，手动给属性赋了值。</p>
</li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Golang/">Golang</a><a class="link-muted mr-2" rel="tag" href="/tags/Microservices/">Microservices</a><a class="link-muted mr-2" rel="tag" href="/tags/Translation/">Translation</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/04/19/openstackTroubleshoot/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">[Openstack] 重部署记录</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/04/08/MicroservicesinGolangPart2/"><span class="level-item">Microservices in Golang - Part2</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#引言"><span class="mr-2">1</span><span>引言</span></a></li><li><a class="is-flex" href="#开始之前"><span class="mr-2">2</span><span>开始之前</span></a></li><li><a class="is-flex" href="#数据库"><span class="mr-2">3</span><span>数据库</span></a><ul class="menu-list"><li><a class="is-flex" href="#SQL-还是-NoSQL-？"><span class="mr-2">3.1</span><span>SQL 还是 NoSQL ？</span></a></li></ul></li><li><a class="is-flex" href="#docker-compose"><span class="mr-2">4</span><span>docker-compose</span></a><ul class="menu-list"><li><a class="is-flex" href="#容器编排"><span class="mr-2">4.1</span><span>容器编排</span></a></li><li><a class="is-flex" href="#运行一下"><span class="mr-2">4.2</span><span>运行一下</span></a></li><li><a class="is-flex" href="#consignment-service-重构"><span class="mr-2">4.3</span><span>consignment-service 重构</span></a><ul class="menu-list"><li><a class="is-flex" href="#repository-go-与MongoDB交互"><span class="mr-2">4.3.1</span><span>repository.go 与MongoDB交互</span></a></li><li><a class="is-flex" href="#datastore-go-创建连接"><span class="mr-2">4.3.2</span><span>datastore.go 创建连接</span></a></li><li><a class="is-flex" href="#重构-main-go"><span class="mr-2">4.3.3</span><span>重构 main.go</span></a></li><li><a class="is-flex" href="#handler-go-处理服务请求"><span class="mr-2">4.3.4</span><span>handler.go 处理服务请求</span></a></li></ul></li><li><a class="is-flex" href="#vessel-service-重构"><span class="mr-2">4.4</span><span>vessel-service 重构</span></a><ul class="menu-list"><li><a class="is-flex" href="#新增货轮-Create"><span class="mr-2">4.4.1</span><span>新增货轮 Create()</span></a></li><li><a class="is-flex" href="#repository-go-与数据库连接"><span class="mr-2">4.4.2</span><span>repository.go 与数据库连接</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#User-service"><span class="mr-2">5</span><span>User service</span></a><ul class="menu-list"><li><a class="is-flex" href="#user-proto"><span class="mr-2">5.1</span><span>user.proto</span></a></li><li><a class="is-flex" href="#Makefile"><span class="mr-2">5.2</span><span>Makefile</span></a></li><li><a class="is-flex" href="#handler-go"><span class="mr-2">5.3</span><span>handler.go</span></a></li><li><a class="is-flex" href="#repository-go"><span class="mr-2">5.4</span><span>repository.go</span></a></li><li><a class="is-flex" href="#extension-go"><span class="mr-2">5.5</span><span>extension.go</span></a></li></ul></li><li><a class="is-flex" href="#Gorm-Go-ORM"><span class="mr-2">6</span><span>Gorm - Go + ORM</span></a></li><li><a class="is-flex" href="#Troubleshoot"><span class="mr-2">7</span><span>Troubleshoot</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-11T07:41:18.000Z">2020-05-11</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/11/MicroservicesinGolangPart5/">Microservices in Golang - Part5</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a> / <a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-09T04:07:19.000Z">2020-05-09</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/09/OpenWhisk1/">[Serverless] OpenWhisk</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-06T12:48:29.000Z">2020-05-06</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/06/DockerfileRUNCMDENTRY/">[Docker] 如何向容器中传入参数</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-02T00:53:42.000Z">2020-05-02</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/02/DockerComposeCheatSheet/">Docker-compose 速查</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Operations/">Operations</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-04-25T06:22:52.000Z">2020-04-25</time></p><p class="title is-6"><a class="link-muted" href="/2020/04/25/OpenStackImageModify/">[OpenStack] 镜像定制</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Operations/">Operations</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a><p class="size-small"><span>&copy; 2020 arithbar</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://fusidic.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>