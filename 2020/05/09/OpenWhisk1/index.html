<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>[Serverless] OpenWhisk - Fusidic&#039;s blog</title><meta description="OpenWhisk 是由 IBM 开源的一个 FaaS 计算平台，在2016年贡献给了开源社区，2019年正式成为 Apache 基金会的顶级项目。 OpenWhisk 本身是一个事件驱动  (Event driven architecture) 的 FaaS (Function as a Service) 计算平台，用户只需要关注业务代码的逻辑，将操作代码发送给 OpenWhisk ，并提供所需"><meta property="og:type" content="blog"><meta property="og:title" content="[Serverless] OpenWhisk"><meta property="og:url" content="https://fusidic.github.io/"><meta property="og:site_name" content="Fusidic&#039;s blog"><meta property="og:description" content="OpenWhisk 是由 IBM 开源的一个 FaaS 计算平台，在2016年贡献给了开源社区，2019年正式成为 Apache 基金会的顶级项目。 OpenWhisk 本身是一个事件驱动  (Event driven architecture) 的 FaaS (Function as a Service) 计算平台，用户只需要关注业务代码的逻辑，将操作代码发送给 OpenWhisk ，并提供所需"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2020/05/09/8fRpD91z7eJjGMT.png"><meta property="og:image" content="https://i.loli.net/2020/05/09/zDn1WkTLIlswtoV.png"><meta property="og:image" content="https://i.loli.net/2020/05/09/NVzwJHnZ7X5gpra.png"><meta property="og:image" content="https://i.loli.net/2020/05/09/sfE1nCSLhvjDump.png"><meta property="article:published_time" content="2020-05-09T04:07:19.000Z"><meta property="article:modified_time" content="2020-05-11T08:05:28.000Z"><meta property="article:author" content="arithbar"><meta property="article:tag" content="Serverless"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://i.loli.net/2020/05/09/8fRpD91z7eJjGMT.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://fusidic.github.io/2020/05/09/OpenWhisk1/"},"headline":"Fusidic's blog","image":["https://i.loli.net/2020/05/09/8fRpD91z7eJjGMT.png","https://i.loli.net/2020/05/09/zDn1WkTLIlswtoV.png","https://i.loli.net/2020/05/09/NVzwJHnZ7X5gpra.png","https://i.loli.net/2020/05/09/sfE1nCSLhvjDump.png"],"datePublished":"2020-05-09T04:07:19.000Z","dateModified":"2020-05-11T08:05:28.000Z","author":{"@type":"Person","name":"arithbar"},"description":"OpenWhisk 是由 IBM 开源的一个 FaaS 计算平台，在2016年贡献给了开源社区，2019年正式成为 Apache 基金会的顶级项目。 OpenWhisk 本身是一个事件驱动  (Event driven architecture) 的 FaaS (Function as a Service) 计算平台，用户只需要关注业务代码的逻辑，将操作代码发送给 OpenWhisk ，并提供所需"}</script><link rel="canonical" href="https://fusidic.github.io/2020/05/09/OpenWhisk1/"><link rel="icon" href="/img/favicon.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/fusidic"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-05-09T04:07:19.000Z" title="2020-05-09T04:07:19.000Z">2020-05-09</time><span class="level-item"><a class="link-muted" href="/categories/Developments/">Developments</a></span><span class="level-item">12 分钟 读完 (大约 1824 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">[Serverless] OpenWhisk</h1><div class="content"><p>OpenWhisk 是由 IBM 开源的一个 FaaS 计算平台，在2016年贡献给了开源社区，2019年正式成为 Apache 基金会的顶级项目。</p>
<p>OpenWhisk 本身是一个事件驱动  (<a href="https://en.wikipedia.org/wiki/Event-driven_architecture">Event driven architecture</a>) 的 FaaS (Function as a Service) 计算平台，用户只需要关注业务代码的逻辑，将操作代码发送给 OpenWhisk ，并提供所需的数据流，OpenWhisk 就能自动的对计算资源进行扩展。开发者无需关心相关的基础设施架构，虽说理论上有效的提高了开发效率，可以使开发人员可以将精力放在代码逻辑上，不过 Serverless 平台的开发体验还是颇受诟病的，由于无法接触到实际的运行环境，不管是开发还是 debug 都比较不方便，只通过 log 方式调试错误。</p>
<a id="more"></a>

<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>试水 OpenWhisk ，你可以直接试试 <a href="https://new-console.ng.bluemix.net/openwhisk/?_ga=2.130500748.262063278.1588941019-1403270861.1588730595">IBM Bluemix</a>, 这是 IBM 公司提供的一个 FaaS 服务，参考<a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-python-openwhisk-bluemix-trs/index.html">这篇文章</a>。</p>
<p>或者你也可以在本地自己构建一个 OpenWhisk 的平台，由于<a href="https://github.com/projectodd/incubator-openwhisk">官方</a>提供了完善的部署方案，所以现在你只需要：</p>
<ul>
<li><p>Ubuntu (其他发行版也是可以的)</p>
</li>
<li><p>Git</p>
</li>
</ul>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>比较棒的是，官方提供了脚本解决所有依赖的问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install git if it is not installed</span></span><br><span class="line">$ sudo apt-get install git -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Clone openwhisk</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/apache/openwhisk.git openwhisk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转移到 openwhisk 文件夹</span></span><br><span class="line">$ <span class="built_in">cd</span> openwhisk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所有依赖</span></span><br><span class="line">$ <span class="built_in">cd</span> tools/ubuntu-setup &amp;&amp; ./all.sh</span><br></pre></td></tr></table></figure>



<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>这里需要一个 NoSQL 数据来支撑 OpenWhisk 的数据持久化、用户鉴权认证等能力，就决定是你了—— CouchDB.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 校验</span></span><br><span class="line">$ curl -L https://couchdb.apache.org/repo/bintray-pubkey.asc | apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加apache软件源</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"deb https://apache.bintray.com/couchdb-deb bionic main"</span> | tee -a /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新软件源</span></span><br><span class="line">$ sudo apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 couchdb</span></span><br><span class="line">$ sudo apt-get install -y couchdb</span><br></pre></td></tr></table></figure>

<p>此时会看到下图，选择单节点 standalone:</p>
<p><img src="https://i.loli.net/2020/05/09/8fRpD91z7eJjGMT.png" alt="安装模式.png"></p>
<p>绑定 IP 0.0.0.0 :</p>
<p><img src="https://i.loli.net/2020/05/09/zDn1WkTLIlswtoV.png" alt="绑定地址.png"></p>
<p>接下来设置并确认用户 <code>admin</code> 的密码，就不放图了。</p>
<p>安装完成后，可以使用 <code>$ sudo service couchdb status</code> 查看 couchdb 的运行状态:</p>
<p><img src="https://i.loli.net/2020/05/09/NVzwJHnZ7X5gpra.png" alt="couchdb.png"></p>
<p>也可以试着访问 <a href="http://127.0.0.1:5984/_utils/">http://127.0.0.1:5984/_utils/</a> ，可以看到 CouchDB 的管理界面。</p>
<p><img src="https://i.loli.net/2020/05/09/sfE1nCSLhvjDump.png" alt="couchdb界面.png"></p>
<p>当然也可以直接使用 REST API 来对数据库进行操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://admin:password@127.0.0.1:5984/_all_dbs</span><br><span class="line">[<span class="string">"_global_changes"</span>,<span class="string">"_replicator"</span>,<span class="string">"_users"</span>]</span><br><span class="line"></span><br><span class="line">$ curl http://admin:password@127.0.0.1:5984/_global_changes</span><br><span class="line">&#123;<span class="string">"db_name"</span>:<span class="string">"_global_changes"</span>,<span class="string">"update_seq"</span>:<span class="string">"4-g1AAAAFTeJzLYWBg4MhgTmEQTM4vTc5ISXLIyU9OzMnILy7JAUoxJTIkyf___z8rkQGPoiQFIJlkD1bHiE-dA0hdPGHzEkDq6gmal8cCJBkagBRQ6Xz8ZkLULoCo3U-M2gMQtfeJUfsAohboXqYsANYbbzI"</span>,<span class="string">"sizes"</span>:&#123;<span class="string">"file"</span>:13699,<span class="string">"external"</span>:16,<span class="string">"active"</span>:860&#125;,<span class="string">"purge_seq"</span>:0,<span class="string">"other"</span>:&#123;<span class="string">"data_size"</span>:16&#125;,<span class="string">"doc_del_count"</span>:0,<span class="string">"doc_count"</span>:4,<span class="string">"disk_size"</span>:13699,<span class="string">"disk_format_version"</span>:6,<span class="string">"data_size"</span>:860,<span class="string">"compact_running"</span>:<span class="literal">false</span>,<span class="string">"cluster"</span>:&#123;<span class="string">"q"</span>:8,<span class="string">"n"</span>:1,<span class="string">"w"</span>:1,<span class="string">"r"</span>:1&#125;,<span class="string">"instance_start_time"</span>:<span class="string">"0"</span>&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="安装-OpenWhisk"><a href="#安装-OpenWhisk" class="headerlink" title="安装 OpenWhisk"></a>安装 OpenWhisk</h2><p>之前已经将 OpenWhisk 的仓库拉取下来了，现在请先回到 <code>$ cd openwhisk</code> 的目录下，OpenWhisk 还提供了 <code>ansible</code> 工具，极大简化了安装的过程。</p>
<ul>
<li><p>首先请先确保一下端口没有被占用:</p>
<ul>
<li><p><code>80</code>, <code>443</code>, <code>9000</code>, <code>9001</code>, and <code>9090</code> for the API Gateway</p>
</li>
<li><p><code>6379</code> for Redis</p>
</li>
<li><p><code>2181</code> for Zookeeper</p>
</li>
<li><p><code>5984</code> for CouchDB</p>
</li>
<li><p><code>8085</code>, <code>9333</code> for OpenWhisk’s Invoker</p>
</li>
<li><p><code>8888</code>, <code>9222</code> for OpenWhisk’s Controller</p>
</li>
<li><p><code>9092</code> for Kafka</p>
</li>
<li><p><code>8001</code> for Kafka Topics UI</p>
<blockquote>
<p>注意：</p>
<p>所有涉及 Ansible 的操作都需要在 <code>ansible</code> 路径下执行，这是由于 <code>ansible/ansible.cfg</code> 中包含了所有的通用设定。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>切换到 ansible 路径</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ansible</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置数据库的环境变量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> OW_DB_PROTOCOL=http</span><br><span class="line">$ <span class="built_in">export</span> OW_DB_HOST=&lt;public IP&gt;</span><br><span class="line">$ <span class="built_in">export</span> OW_DB_PORT=5984</span><br><span class="line">$ <span class="built_in">export</span> OW_DB_USERNAME=admin</span><br><span class="line">$ <span class="built_in">export</span> OW_DB_PASSWORD=password</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：</p>
<p><code>&lt;public IP&gt;</code> 填写本机 IP，可以用 <code>ip a</code> 查看</p>
<p><code>password</code> 填写之前设置的数据库密码</p>
</blockquote>
</li>
<li><p>生成初始配置，这一步在开发环境中必须先执行，它会根据你的环境生成一个 <code>hosts</code> 配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook setup.yml</span><br></pre></td></tr></table></figure>

<p>如果需要，可以在配置文件中加入多个节点的信息，在使用 Ansible 时加入 <code>-e mode=HA</code> 的选项启用高可用，在多个服务器中配置多个 Kafka, invokers 的实例。</p>
<p>这一步有问题，可以尝试 (后同)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i environments/<span class="built_in">local</span> setup.yml</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>在所有 openwhisk 节点上安装环境依赖 (其实在单节点的配置中，这一步可以不做，所有依赖都已经装上了)</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook prereq.yml</span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Gathering Facts ------------------------ 0.78s</span><br><span class="line">prereq : install docker <span class="keyword">for</span> python ----- 0.66s</span><br><span class="line">prereq : install requests -------------- 0.64s</span><br><span class="line">prereq : install httplib2 -------------- 0.64s</span><br><span class="line">Gathering Facts ------------------------ 0.55s</span><br><span class="line">Gathering Facts ------------------------ 0.55s</span><br><span class="line">Gathering Facts ------------------------ 0.55s</span><br><span class="line">prereq : check <span class="keyword">for</span> pip ----------------- 0.44s</span><br><span class="line">prereq : install pip ------------------- 0.03s</span><br><span class="line">prereq : remove docker ----------------- 0.03s</span><br><span class="line">prereq : remove requests --------------- 0.03s</span><br><span class="line">prereq : remove httplib2 --------------- 0.02s</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建 docker 镜像</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到 openwhisk 目录</span></span><br><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line">$ ./gradlew distDocker</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ./ansible</span><br><span class="line"></span><br><span class="line">$ ansible-playbook initdb.yml</span><br><span class="line">$ ansible-playbook wipe.yml</span><br><span class="line">$ ansible-playbook openwhisk.yml</span><br><span class="line">$ ansible-playbook postdeploy.yml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：</p>
<p><code>initdb.yml</code> 在每次新部署并初始化 CounchDB 时都需要运行一次</p>
<p><code>wipe.yml</code> 每次部署前需要运行一次</p>
<p><code>$ ansible-playbook openwhisk.yml</code> 避免在重启后数据库数据丢失，这一步会拉取很多镜像，花的时间很长，耐心等待</p>
<p>同样的用法使用 <code>apigateway.yml</code> 和 <code>routermgmt.yml</code> 启用 API 网关</p>
</blockquote>
</li>
<li><p>安装完成后，可以使用 <code>docker ps -a</code> 查看所有容器的运行状态：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                                                                                                 NAMES</span><br><span class="line">73c17753ad74        nginx:1.13                       <span class="string">"nginx -g 'daemon of…"</span>   2 minutes ago       Up 2 minutes        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:8443-&gt;8443/tcp                                      nginx</span><br><span class="line">b51d882d6295        openwhisk/nodejs6action:latest   <span class="string">"/bin/sh -c 'node --…"</span>   2 minutes ago       Up 2 minutes                                                                                                              wsk00_4_prewarm_nodejs6</span><br><span class="line">cb6d90d7fce5        openwhisk/nodejs6action:latest   <span class="string">"/bin/sh -c 'node --…"</span>   2 minutes ago       Up 2 minutes                                                                                                              wsk00_2_prewarm_nodejs6</span><br><span class="line">e83e0a8ff8a3        whisk/invoker:latest             <span class="string">"/bin/sh -c 'exec /i…"</span>   2 minutes ago       Up 2 minutes        0.0.0.0:17000-&gt;17000/tcp, 0.0.0.0:18000-&gt;18000/tcp, 0.0.0.0:12001-&gt;8080/tcp                           invoker0</span><br><span class="line">3f1287e56e07        whisk/controller:latest          <span class="string">"/bin/sh -c 'exec /i…"</span>   10 minutes ago      Up 10 minutes       0.0.0.0:15000-&gt;15000/tcp, 0.0.0.0:16000-&gt;16000/tcp, 0.0.0.0:8000-&gt;2551/tcp, 0.0.0.0:10001-&gt;8080/tcp   controller0</span><br><span class="line">e4f4b8a35182        wurstmeister/kafka:0.11.0.1      <span class="string">"start-kafka.sh"</span>         10 minutes ago      Up 10 minutes       0.0.0.0:9072-&gt;9072/tcp, 0.0.0.0:9093-&gt;9093/tcp                                                        kafka0</span><br><span class="line">db10c72113e4        zookeeper:3.4                    <span class="string">"/docker-entrypoint.…"</span>   10 minutes ago      Up 10 minutes       0.0.0.0:2181-&gt;2181/tcp, 0.0.0.0:2888-&gt;2888/tcp, 0.0.0.0:3888-&gt;3888/tcp                                zookeeper0</span><br><span class="line">71df5847d252        redis:3.2                        <span class="string">"docker-entrypoint.s…"</span>   22 minutes ago      Up 22 minutes       0.0.0.0:6379-&gt;6379/tcp                                                                                redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>将二进制文件加入到 <code>PATH</code> 中</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../bin</span><br><span class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$PWD</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装完成</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ wsk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ____      ___                   _    _ _     _     _</span><br><span class="line">       /\   \    / _ \ _ __   ___ _ __ | |  | | |__ (_)___| | __</span><br><span class="line">  /\  /__\   \  | | | | <span class="string">'_ \ / _ \ '</span>_ \| |  | | <span class="string">'_ \| / __| |/ /</span></span><br><span class="line"><span class="string"> /  \____ \  /  | |_| | |_) |  __/ | | | |/\| | | | | \__ \   &lt;</span></span><br><span class="line"><span class="string"> \   \  /  \/    \___/| .__/ \___|_| |_|__/\__|_| |_|_|___/_|\_\</span></span><br><span class="line"><span class="string">  \___\/ tm           |_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Usage:</span></span><br><span class="line"><span class="string">  wsk [command]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Available Commands:</span></span><br><span class="line"><span class="string">  action      work with actions</span></span><br><span class="line"><span class="string">  activation  work with activations</span></span><br><span class="line"><span class="string">  package     work with packages</span></span><br><span class="line"><span class="string">  rule        work with rules</span></span><br><span class="line"><span class="string">  trigger     work with triggers</span></span><br><span class="line"><span class="string">  sdk         work with the sdk</span></span><br><span class="line"><span class="string">  property    work with whisk properties</span></span><br><span class="line"><span class="string">  namespace   work with namespaces</span></span><br><span class="line"><span class="string">  list        list entities in the current namespace</span></span><br><span class="line"><span class="string">  api         work with APIs</span></span><br><span class="line"><span class="string">  project     The OpenWhisk Project Management Tool</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Flags:</span></span><br><span class="line"><span class="string">      --apihost HOST         whisk API HOST</span></span><br><span class="line"><span class="string">      --apiversion VERSION   whisk API VERSION</span></span><br><span class="line"><span class="string">  -u, --auth KEY             authorization KEY</span></span><br><span class="line"><span class="string">      --cert string          client cert</span></span><br><span class="line"><span class="string">  -d, --debug                debug level output</span></span><br><span class="line"><span class="string">  -h, --help                 help for wsk</span></span><br><span class="line"><span class="string">  -i, --insecure             bypass certificate checking</span></span><br><span class="line"><span class="string">      --key string           client key</span></span><br><span class="line"><span class="string">  -v, --verbose              verbose output</span></span><br></pre></td></tr></table></figure>

<p>  可以看到 <code>wsk</code> 命令的相关说明。</p>
</li>
</ul>
<br/>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>设置 API host，在单机配置中的 IP 应该为 172.17.0.1。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wsk property <span class="built_in">set</span> –apihost 172.17.0.1</span><br></pre></td></tr></table></figure>

<p>设置 key (注意在 openwhisk 路径下执行)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wsk property <span class="built_in">set</span> --auth `cat ansible/files/auth.guest`</span><br></pre></td></tr></table></figure>

<p>创建一个测试文件 <code>hello.js</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano hello.js</span><br></pre></td></tr></table></figure>

<p>简单的demo，复制以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world as an OpenWhisk action.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = params.name || <span class="string">'World'</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">payload</span>:  <span class="string">'Hello, '</span> + name + <span class="string">'!'</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 <code>action</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wsk -i action create hello hello.js</span><br></pre></td></tr></table></figure>

<p>通过 <code>wsk</code> 命令调用上面的 <code>action</code> ，加入 <code>-i</code> 可以禁用认证服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wsk -i action invoke hello --result</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"payload"</span>: <span class="string">"Hello, World!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/apache/openwhisk/tree/master/ansible">https://github.com/apache/openwhisk/tree/master/ansible</a></li>
<li><a href="https://github.com/apache/openwhisk/blob/master/tools/ubuntu-setup/README.md">https://github.com/apache/openwhisk/blob/master/tools/ubuntu-setup/README.md</a></li>
<li><a href="https://github.com/apache/openwhisk/blob/master/docs/cli.md">https://github.com/apache/openwhisk/blob/master/docs/cli.md</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-lo-local-deployment-and-application-of-openwhisk/index.html">https://www.ibm.com/developerworks/cn/cloud/library/cl-lo-local-deployment-and-application-of-openwhisk/index.html</a></li>
<li><a href="https://medium.com/@Alibaba_Cloud/how-to-set-up-apache-openwhisk-on-ubuntu-18-04-part-ii-eb428f36177b">https://medium.com/@Alibaba_Cloud/how-to-set-up-apache-openwhisk-on-ubuntu-18-04-part-ii-eb428f36177b</a></li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Serverless/">Serverless</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/05/11/MicroservicesinGolangPart5/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Microservices in Golang - Part5</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/05/06/DockerfileRUNCMDENTRY/"><span class="level-item">[Docker] 如何向容器中传入参数</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#准备工作"><span class="mr-2">1</span><span>准备工作</span></a></li><li><a class="is-flex" href="#依赖"><span class="mr-2">2</span><span>依赖</span></a></li><li><a class="is-flex" href="#数据库"><span class="mr-2">3</span><span>数据库</span></a></li><li><a class="is-flex" href="#安装-OpenWhisk"><span class="mr-2">4</span><span>安装 OpenWhisk</span></a></li><li><a class="is-flex" href="#Demo"><span class="mr-2">5</span><span>Demo</span></a></li><li><a class="is-flex" href="#参考"><span class="mr-2">6</span><span>参考</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T13:44:16.000Z">2020-06-04</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/04/LinuxNetworkAnalyze/">Linux 网络分析</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Operations/">Operations</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-28T02:53:13.000Z">2020-05-28</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/28/NFVpractice/">[NFV] 虚拟网络</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Operations/">Operations</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-25T07:59:18.000Z">2020-05-25</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/25/NFV1LXD/">[NFV] LXD</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Operations/">Operations</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-17T08:48:36.000Z">2020-05-17</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/17/MicroservicesinGolangPart7/">Microservices in Golang - Part7</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a> / <a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-05-13T06:54:45.000Z">2020-05-13</time></p><p class="title is-6"><a class="link-muted" href="/2020/05/13/MicroservicesinGolangPart6/">Microservices in Golang - Part6</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Developments/">Developments</a> / <a class="link-muted" href="/categories/Developments/Microservices/">Microservices</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Fusidic&#039;s blog" height="28"></a><p class="size-small"><span>&copy; 2020 arithbar</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://fusidic.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>